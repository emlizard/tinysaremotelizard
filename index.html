<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>tinySA Ultra 웹 컨트롤러</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: #fff;
            min-height: 100vh;
        }

        .header {
            background: rgba(0, 0, 0, 0.3);
            padding: 1rem;
            text-align: center;
            backdrop-filter: blur(10px);
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .status {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-top: 1rem;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #f44336;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #4caf50;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .container {
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            gap: 1rem;
            padding: 1rem;
            max-width: 1400px;
            margin: 0 auto;
            min-height: calc(100vh - 140px);
        }

        .panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .section {
            margin-bottom: 2rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section h3 {
            color: #64b5f6;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .input-group {
            margin-bottom: 1rem;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #e3f2fd;
        }

        input, select, button {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #64b5f6;
            box-shadow: 0 0 10px rgba(100, 181, 246, 0.3);
        }

        button {
            background: linear-gradient(45deg, #42a5f5, #1976d2);
            border: none;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
        }

        button:hover {
            background: linear-gradient(45deg, #1976d2, #1565c0);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(25, 118, 210, 0.4);
        }

        button:disabled {
            background: rgba(255, 255, 255, 0.1);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .display-area {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .screen-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
        }

        .device-screen {
            background: #000;
            border: 3px solid #333;
            border-radius: 10px;
            margin: 0 auto;
            position: relative;
            cursor: crosshair;
            display: inline-block;
        }

        .device-screen canvas {
            display: block;
            border-radius: 7px;
        }

        .screen-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #fff;
            font-size: 1.2rem;
            border-radius: 7px;
        }

        .chart-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 1.5rem;
            height: 350px;
            position: relative;
        }

        .chart-container canvas {
            border-radius: 8px;
            background: #1a1a1a;
            width: 100% !important;
            height: 250px !important;
        }

        .terminal {
            background: #000;
            color: #0f0;
            font-family: 'Courier New', monospace;
            padding: 1rem;
            border-radius: 8px;
            height: 200px;
            overflow-y: auto;
            font-size: 0.8rem;
            border: 1px solid #333;
        }

        .terminal-line {
            margin-bottom: 0.25rem;
        }

        .measurements {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .measurement-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        .measurement-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #64b5f6;
            margin-bottom: 0.5rem;
        }

        .measurement-label {
            font-size: 0.9rem;
            color: #e3f2fd;
        }

        .controls {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .controls button {
            flex: 1;
            padding: 0.5rem;
            font-size: 0.8rem;
        }

        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5rem;
            }
            
            .measurements {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>📡 tinySA Ultra 웹 컨트롤러</h1>
        <div class="status">
            <div class="status-dot" id="statusDot"></div>
            <span id="connectionStatus">연결 안됨</span>
            <select id="deviceType" style="width: auto; margin-left: 1rem;">
                <option value="tinysa-ultra">tinySA Ultra</option>
                <option value="tinysa">tinySA</option>
                <option value="nanovna">NanoVNA-H</option>
                <option value="nanovna-h4">NanoVNA-H4</option>
            </select>
        </div>
    </div>

    <div class="container">
        <!-- 왼쪽 제어 패널 -->
        <div class="panel">
            <!-- 연결 상태 -->
            <div class="section">
                <h3>🔌 장비 연결</h3>
                <button id="connectBtn">장비 연결</button>
                <button id="disconnectBtn" disabled>연결 해제</button>
                <div style="margin-top: 1rem; font-size: 0.9rem; color: #ccc;">
                    <div>상태: <span id="deviceStatus">대기 중</span></div>
                    <div>FPS: <span id="fpsDisplay">0</span></div>
                    <div>데이터: <span id="dataCount">0</span> 포인트</div>
                </div>
            </div>

            <!-- 주파수 설정 -->
            <div class="section">
                <h3>📡 주파수 설정</h3>
                <div class="input-group">
                    <label>시작 주파수 (MHz)</label>
                    <input type="number" id="startFreq" value="0.1" step="0.1">
                </div>
                <div class="input-group">
                    <label>종료 주파수 (MHz)</label>
                    <input type="number" id="stopFreq" value="350" step="0.1">
                </div>
                <div class="input-group">
                    <label>측정 포인트</label>
                    <select id="points">
                        <option value="101">101</option>
                        <option value="201">201</option>
                        <option value="401">401</option>
                    </select>
                </div>
                <button id="setFreqBtn">주파수 설정</button>
            </div>

            <!-- 스캔 제어 -->
            <div class="section">
                <h3>🔍 스캔 제어</h3>
                <button id="scanBtn">스펙트럼 스캔</button>
                <button id="sweepBtn">S-parameter 측정</button>
                <div class="controls">
                    <button id="pauseBtn" disabled>일시정지</button>
                    <button id="resumeBtn" disabled>재개</button>
                </div>
                <button id="testDataBtn">테스트 데이터 생성</button>
            </div>

            <!-- 캘리브레이션 -->
            <div class="section">
                <h3>🎯 캘리브레이션</h3>
                <button id="calBtn">캘리브레이션 실행</button>
                <div class="controls">
                    <button id="saveCalBtn">저장</button>
                    <button id="loadCalBtn">로드</button>
                </div>
            </div>
        </div>

        <!-- 중앙 디스플레이 영역 -->
        <div class="display-area">
            <!-- 화면 미러링 -->
            <div class="screen-container">
                <h3 style="color: #64b5f6; margin-bottom: 1rem;">📺 실시간 화면</h3>
                <div class="device-screen" id="deviceScreen">
                    <canvas id="screenCanvas" width="480" height="320"></canvas>
                    <div class="screen-overlay" id="screenOverlay">
                        <div>🔌 장비를 연결하세요</div>
                        <div style="font-size: 0.9rem; margin-top: 1rem; opacity: 0.7;">
                            클릭하여 연결하거나 시뮬레이션 모드로 테스트
                        </div>
                    </div>
                </div>
                <div style="margin-top: 1rem; font-size: 0.9rem;">
                    화면을 클릭하여 장비 조작 | 키보드: +/- 줌, S 스크린샷
                </div>
            </div>

            <!-- 스펙트럼 차트 -->
            <div class="chart-container">
                <h3 style="color: #64b5f6; margin-bottom: 1rem;">📊 스펙트럼 분석</h3>
                <canvas id="spectrumChart" width="800" height="250"></canvas>
                <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #ccc;">
                    스펙트럼 데이터: <span id="spectrumStatus">데이터 없음</span>
                </div>
            </div>
        </div>

        <!-- 오른쪽 제어 패널 -->
        <div class="panel">
            <!-- 측정값 -->
            <div class="section">
                <h3>📊 측정값</h3>
                <div class="measurements">
                    <div class="measurement-card">
                        <div class="measurement-value" id="peakFreq">-</div>
                        <div class="measurement-label">Peak 주파수</div>
                    </div>
                    <div class="measurement-card">
                        <div class="measurement-value" id="peakPower">-</div>
                        <div class="measurement-label">Peak 파워</div>
                    </div>
                    <div class="measurement-card">
                        <div class="measurement-value" id="s11Value">-</div>
                        <div class="measurement-label">S11 (dB)</div>
                    </div>
                    <div class="measurement-card">
                        <div class="measurement-value" id="vswr">-</div>
                        <div class="measurement-label">VSWR</div>
                    </div>
                </div>
            </div>

            <!-- 데이터 저장 -->
            <div class="section">
                <h3>💾 데이터 관리</h3>
                <button id="saveDataBtn">측정 데이터 저장</button>
                <button id="saveImageBtn">스크린샷 저장</button>
                <button id="exportCsvBtn">CSV 내보내기</button>
            </div>

            <!-- 시스템 제어 -->
            <div class="section">
                <h3>⚙️ 시스템</h3>
                <button id="resetBtn">시스템 리셋</button>
                <button id="vbatBtn">배터리 체크</button>
                <button id="infoBtn">장비 정보</button>
            </div>

            <!-- 명령어 -->
            <div class="section">
                <h3>💻 명령어</h3>
                <div class="input-group">
                    <input type="text" id="commandInput" placeholder="명령어 입력..." value="help">
                </div>
                <button id="sendCommandBtn">명령 전송</button>
            </div>

            <!-- 통신 로그 -->
            <div class="section">
                <h3>📟 통신 로그</h3>
                <div class="terminal" id="terminal">
                    <div class="terminal-line">tinySA Ultra 웹 컨트롤러 v1.1</div>
                    <div class="terminal-line">개선된 버전으로 시작합니다.</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('스크립트 로딩 시작...');
        
        class TinySAController {
            constructor() {
                console.log('TinySAController 생성자 시작');
                
                // 기본 속성
                this.isConnected = false;
                this.serialPort = null;
                this.deviceType = 'tinysa-ultra';
                this.zoom = 1;
                this.isCapturing = false;
                this.isPaused = false;
                this.fps = 0;
                this.frameCount = 0;
                this.lastFpsUpdate = Date.now();
                
                // WebSerial 지원 확인
                this.simulationMode = !('serial' in navigator) || window.location.protocol !== 'https:';
                
                // 측정 데이터 초기화
                this.spectrumData = {
                    frequencies: [],
                    powers: []
                };
                
                console.log('시뮬레이션 모드:', this.simulationMode);
                
                // 초기화
                this.initializeElements();
                this.setupEventListeners();
                this.initializeCanvases();
                this.logToTerminal('✅ 컨트롤러 초기화 완료');
                
                if (this.simulationMode) {
                    this.logToTerminal('🎮 시뮬레이션 모드 - 모든 기능 테스트 가능');
                    this.logToTerminal('💡 "테스트 데이터 생성" 버튼을 클릭해보세요');
                } else {
                    this.logToTerminal('🔗 실제 연결 모드 - 장비 연결 버튼을 클릭하세요');
                }
            }

            initializeElements() {
                console.log('DOM 요소 초기화 중...');
                
                // 필수 요소들
                this.elements = {
                    statusDot: document.getElementById('statusDot'),
                    connectionStatus: document.getElementById('connectionStatus'),
                    deviceType: document.getElementById('deviceType'),
                    deviceStatus: document.getElementById('deviceStatus'),
                    fpsDisplay: document.getElementById('fpsDisplay'),
                    dataCount: document.getElementById('dataCount'),
                    connectBtn: document.getElementById('connectBtn'),
                    disconnectBtn: document.getElementById('disconnectBtn'),
                    startFreq: document.getElementById('startFreq'),
                    stopFreq: document.getElementById('stopFreq'),
                    points: document.getElementById('points'),
                    setFreqBtn: document.getElementById('setFreqBtn'),
                    scanBtn: document.getElementById('scanBtn'),
                    sweepBtn: document.getElementById('sweepBtn'),
                    pauseBtn: document.getElementById('pauseBtn'),
                    resumeBtn: document.getElementById('resumeBtn'),
                    testDataBtn: document.getElementById('testDataBtn'),
                    calBtn: document.getElementById('calBtn'),
                    saveCalBtn: document.getElementById('saveCalBtn'),
                    loadCalBtn: document.getElementById('loadCalBtn'),
                    deviceScreen: document.getElementById('deviceScreen'),
                    screenOverlay: document.getElementById('screenOverlay'),
                    screenCanvas: document.getElementById('screenCanvas'),
                    spectrumChart: document.getElementById('spectrumChart'),
                    spectrumStatus: document.getElementById('spectrumStatus'),
                    peakFreq: document.getElementById('peakFreq'),
                    peakPower: document.getElementById('peakPower'),
                    s11Value: document.getElementById('s11Value'),
                    vswr: document.getElementById('vswr'),
                    saveDataBtn: document.getElementById('saveDataBtn'),
                    saveImageBtn: document.getElementById('saveImageBtn'),
                    exportCsvBtn: document.getElementById('exportCsvBtn'),
                    resetBtn: document.getElementById('resetBtn'),
                    vbatBtn: document.getElementById('vbatBtn'),
                    infoBtn: document.getElementById('infoBtn'),
                    commandInput: document.getElementById('commandInput'),
                    sendCommandBtn: document.getElementById('sendCommandBtn'),
                    terminal: document.getElementById('terminal')
                };
                
                // 누락된 요소 확인
                const missingElements = [];
                for (const [key, element] of Object.entries(this.elements)) {
                    if (!element) {
                        missingElements.push(key);
                    }
                }
                
                if (missingElements.length > 0) {
                    console.warn('누락된 요소들:', missingElements);
                } else {
                    console.log('모든 DOM 요소 초기화 완료');
                }
            }

            setupEventListeners() {
                console.log('이벤트 리스너 설정 중...');
                
                try {
                    // 장비 타입 변경
                    this.elements.deviceType?.addEventListener('change', (e) => {
                        this.deviceType = e.target.value;
                        this.updateDeviceConfig();
                    });

                    // 연결 제어
                    this.elements.connectBtn?.addEventListener('click', () => this.connect());
                    this.elements.disconnectBtn?.addEventListener('click', () => this.disconnect());

                    // 주파수 설정
                    this.elements.setFreqBtn?.addEventListener('click', () => this.setFrequencies());

                    // 스캔 제어
                    this.elements.scanBtn?.addEventListener('click', () => this.startScan());
                    this.elements.sweepBtn?.addEventListener('click', () => this.startSweep());
                    this.elements.pauseBtn?.addEventListener('click', () => this.pauseCapture());
                    this.elements.resumeBtn?.addEventListener('click', () => this.resumeCapture());
                    this.elements.testDataBtn?.addEventListener('click', () => this.generateTestData());

                    // 캘리브레이션
                    this.elements.calBtn?.addEventListener('click', () => this.calibrate());
                    this.elements.saveCalBtn?.addEventListener('click', () => this.saveCalibration());
                    this.elements.loadCalBtn?.addEventListener('click', () => this.loadCalibration());

                    // 데이터 관리
                    this.elements.saveDataBtn?.addEventListener('click', () => this.saveData());
                    this.elements.saveImageBtn?.addEventListener('click', () => this.saveImage());
                    this.elements.exportCsvBtn?.addEventListener('click', () => this.exportCsv());

                    // 시스템 제어
                    this.elements.resetBtn?.addEventListener('click', () => this.systemReset());
                    this.elements.vbatBtn?.addEventListener('click', () => this.checkBattery());
                    this.elements.infoBtn?.addEventListener('click', () => this.getDeviceInfo());

                    // 명령어
                    this.elements.sendCommandBtn?.addEventListener('click', () => this.sendCommand());
                    this.elements.commandInput?.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') this.sendCommand();
                    });

                    // 화면 클릭
                    this.elements.screenCanvas?.addEventListener('click', (e) => this.handleScreenClick(e));

                    // 키보드 단축키
                    document.addEventListener('keydown', (e) => {
                        switch (e.key) {
                            case '+':
                                this.zoom = Math.min(this.zoom + 0.2, 3);
                                this.updateScreenSize();
                                break;
                            case '-':
                                this.zoom = Math.max(this.zoom - 0.2, 0.5);
                                this.updateScreenSize();
                                break;
                            case 's':
                            case 'S':
                                if (e.ctrlKey) return;
                                e.preventDefault();
                                this.saveImage();
                                break;
                        }
                    });

                    console.log('이벤트 리스너 설정 완료');
                } catch (error) {
                    console.error('이벤트 리스너 설정 실패:', error);
                }
            }

            initializeCanvases() {
                console.log('캔버스 초기화 중...');
                
                try {
                    // 화면 미러링 캔버스
                    if (this.elements.screenCanvas) {
                        this.screenCtx = this.elements.screenCanvas.getContext('2d');
                        this.updateDeviceConfig();
                        console.log('화면 캔버스 초기화 완료');
                    }

                    // 스펙트럼 차트 캔버스
                    if (this.elements.spectrumChart) {
                        this.spectrumCtx = this.elements.spectrumChart.getContext('2d');
                        this.drawSpectrumChart();
                        console.log('스펙트럼 캔버스 초기화 완료');
                        console.log('캔버스 크기:', this.elements.spectrumChart.width, 'x', this.elements.spectrumChart.height);
                    }

                    console.log('캔버스 초기화 완료');
                } catch (error) {
                    console.error('캔버스 초기화 실패:', error);
                }
            }

            updateDeviceConfig() {
                const configs = {
                    'tinysa-ultra': { name: 'tinySA Ultra', width: 480, height: 320, maxFreq: 5300 },
                    'tinysa': { name: 'tinySA', width: 320, height: 240, maxFreq: 350 },
                    'nanovna': { name: 'NanoVNA-H', width: 320, height: 240, maxFreq: 900 },
                    'nanovna-h4': { name: 'NanoVNA-H4', width: 480, height: 320, maxFreq: 1500 }
                };

                const config = configs[this.deviceType];
                if (config && this.elements.screenCanvas) {
                    this.elements.screenCanvas.width = config.width;
                    this.elements.screenCanvas.height = config.height;
                    this.updateScreenSize();
                    
                    // 종료 주파수 업데이트
                    if (this.elements.stopFreq) {
                        this.elements.stopFreq.value = config.maxFreq;
                    }
                    
                    this.logToTerminal(`장비 변경: ${config.name} (${config.width}×${config.height})`);
                }
            }

            updateScreenSize() {
                if (this.elements.deviceScreen) {
                    this.elements.deviceScreen.style.transform = `scale(${this.zoom})`;
                }
            }

            async connect() {
                console.log('연결 시작...');
                
                if (this.elements.connectBtn) {
                    this.elements.connectBtn.disabled = true;
                }
                
                this.updateConnectionStatus('연결 중...');
                this.logToTerminal('🔌 장비 연결 시도 중...');

                if (this.simulationMode) {
                    // 시뮬레이션 모드
                    setTimeout(() => {
                        this.isConnected = true;
                        this.updateConnectionStatus('시뮬레이션 연결');
                        this.logToTerminal('✅ 시뮬레이션 모드로 연결됨');
                        this.startSimulation();
                    }, 1000);
                } else {
                    // 실제 연결
                    try {
                        const config = this.getDeviceConfig();
                        
                        this.serialPort = await navigator.serial.requestPort({
                            filters: [{ usbVendorId: 0x0483, usbProductId: 0x5740 }]
                        });

                        await this.serialPort.open({
                            baudRate: 115200,
                            dataBits: 8,
                            stopBits: 1,
                            parity: 'none'
                        });

                        this.isConnected = true;
                        this.updateConnectionStatus('실제 연결');
                        this.logToTerminal('✅ 실제 장비 연결 성공');
                        this.startRealCapture();
                        
                    } catch (error) {
                        this.logToTerminal(`❌ 연결 실패: ${error.message}`);
                        this.updateConnectionStatus('연결 실패');
                        if (this.elements.connectBtn) {
                            this.elements.connectBtn.disabled = false;
                        }
                    }
                }
            }

            getDeviceConfig() {
                const configs = {
                    'tinysa-ultra': { name: 'tinySA Ultra', width: 480, height: 320 },
                    'tinysa': { name: 'tinySA', width: 320, height: 240 },
                    'nanovna': { name: 'NanoVNA-H', width: 320, height: 240 },
                    'nanovna-h4': { name: 'NanoVNA-H4', width: 480, height: 320 }
                };
                return configs[this.deviceType];
            }

            disconnect() {
                console.log('연결 해제...');
                
                this.isCapturing = false;
                this.isConnected = false;
                
                if (this.serialPort) {
                    this.serialPort.close().catch(console.error);
                    this.serialPort = null;
                }
                
                this.updateConnectionStatus('연결 안됨');
                this.logToTerminal('🔌 연결 해제됨');
                
                // 화면 초기화
                if (this.screenCtx) {
                    this.screenCtx.fillStyle = '#000';
                    this.screenCtx.fillRect(0, 0, this.elements.screenCanvas.width, this.elements.screenCanvas.height);
                }
            }

            updateConnectionStatus(status) {
                if (this.elements.connectionStatus) {
                    this.elements.connectionStatus.textContent = status;
                }
                
                if (this.elements.deviceStatus) {
                    this.elements.deviceStatus.textContent = status;
                }
                
                if (this.elements.statusDot) {
                    if (this.isConnected) {
                        this.elements.statusDot.classList.add('connected');
                    } else {
                        this.elements.statusDot.classList.remove('connected');
                    }
                }
                
                if (this.elements.screenOverlay) {
                    this.elements.screenOverlay.style.display = this.isConnected ? 'none' : 'flex';
                }
                
                // 버튼 상태 업데이트
                if (this.elements.connectBtn) {
                    this.elements.connectBtn.disabled = this.isConnected;
                }
                if (this.elements.disconnectBtn) {
                    this.elements.disconnectBtn.disabled = !this.isConnected;
                }
                if (this.elements.pauseBtn) {
                    this.elements.pauseBtn.disabled = !this.isConnected;
                }
                if (this.elements.resumeBtn) {
                    this.elements.resumeBtn.disabled = !this.isConnected;
                }
            }

            startSimulation() {
                console.log('시뮬레이션 시작...');
                
                this.isCapturing = true;
                
                const simulate = () => {
                    if (!this.isCapturing || !this.isConnected) return;
                    
                    if (!this.isPaused) {
                        this.generateSimulatedScreen();
                        this.updateFPS();
                    }
                    
                    setTimeout(simulate, 100); // 10 FPS
                };
                
                simulate();
                
                // 초기 테스트 데이터 생성
                this.generateTestData();
            }

            generateTestData() {
                console.log('🧪 테스트 데이터 생성 시작...');
                this.logToTerminal('🧪 테스트 데이터 생성 중...');
                
                // 시뮬레이션 스펙트럼 데이터 생성
                this.generateSimulatedSpectrum();
                
                // 차트 그리기
                this.drawSpectrumChart();
                
                // 측정값 업데이트
                this.updateMeasurements();
                
                this.logToTerminal('✅ 테스트 데이터 생성 완료');
            }

            generateSimulatedScreen() {
                if (!this.screenCtx) return;
                
                const width = this.elements.screenCanvas.width;
                const height = this.elements.screenCanvas.height;
                
                // 배경
                this.screenCtx.fillStyle = '#000';
                this.screenCtx.fillRect(0, 0, width, height);
                
                // 격자
                this.screenCtx.strokeStyle = '#333';
                this.screenCtx.lineWidth = 1;
                
                for (let i = 0; i <= 10; i++) {
                    const x = (width * i) / 10;
                    this.screenCtx.beginPath();
                    this.screenCtx.moveTo(x, 0);
                    this.screenCtx.lineTo(x, height);
                    this.screenCtx.stroke();
                }
                
                for (let i = 0; i <= 8; i++) {
                    const y = (height * i) / 8;
                    this.screenCtx.beginPath();
                    this.screenCtx.moveTo(0, y);
                    this.screenCtx.lineTo(width, y);
                    this.screenCtx.stroke();
                }
                
                // 시뮬레이션 스펙트럼
                this.screenCtx.strokeStyle = '#0f0';
                this.screenCtx.lineWidth = 2;
                this.screenCtx.beginPath();
                
                const time = Date.now() / 1000;
                for (let x = 0; x < width; x++) {
                    const freq = x / width;
                    const y = height * 0.8 - 
                        Math.sin(freq * Math.PI * 4 + time) * 30 -
                        Math.sin(freq * Math.PI * 8 + time * 2) * 15 -
                        Math.random() * 5;
                    
                    if (x === 0) {
                        this.screenCtx.moveTo(x, y);
                    } else {
                        this.screenCtx.lineTo(x, y);
                    }
                }
                this.screenCtx.stroke();
                
                // 텍스트 정보
                this.screenCtx.fillStyle = '#fff';
                this.screenCtx.font = '12px Arial';
                this.screenCtx.fillText(`${this.getDeviceConfig().name} - 시뮬레이션`, 10, 20);
                this.screenCtx.fillText('100kHz - 350MHz', 10, height - 15);
            }

            generateSimulatedSpectrum() {
                console.log('📊 스펙트럼 데이터 생성 시작...');
                
                const startFreq = parseFloat(this.elements.startFreq?.value || 0.1) * 1e6;
                const stopFreq = parseFloat(this.elements.stopFreq?.value || 350) * 1e6;
                const points = parseInt(this.elements.points?.value || 101);
                
                console.log(`주파수 범위: ${startFreq/1e6} - ${stopFreq/1e6} MHz, 포인트: ${points}`);
                
                // 데이터 배열 초기화
                this.spectrumData.frequencies = [];
                this.spectrumData.powers = [];
                
                for (let i = 0; i < points; i++) {
                    const freq = startFreq + (stopFreq - startFreq) * i / (points - 1);
                    
                    // 더 현실적인 스펙트럼 시뮬레이션
                    let power = -70; // 기본 노이즈 레벨
                    
                    // 몇 개의 피크 추가
                    power += 20 * Math.exp(-Math.pow((freq - startFreq - (stopFreq - startFreq) * 0.3) / (stopFreq - startFreq) * 10, 2));
                    power += 15 * Math.exp(-Math.pow((freq - startFreq - (stopFreq - startFreq) * 0.7) / (stopFreq - startFreq) * 8, 2));
                    
                    // 랜덤 노이즈 추가
                    power += (Math.random() - 0.5) * 8;
                    
                    this.spectrumData.frequencies.push(freq);
                    this.spectrumData.powers.push(power);
                }
                
                // 데이터 카운트 업데이트
                if (this.elements.dataCount) {
                    this.elements.dataCount.textContent = this.spectrumData.powers.length.toString();
                }
                
                console.log(`✅ 생성된 데이터 포인트: ${this.spectrumData.powers.length}`);
                console.log(`파워 범위: ${Math.min(...this.spectrumData.powers).toFixed(1)} ~ ${Math.max(...this.spectrumData.powers).toFixed(1)} dBm`);
                
                this.logToTerminal(`📊 스펙트럼 데이터 생성: ${points}개 포인트`);
            }

            drawSpectrumChart() {
                console.log('📊 스펙트럼 차트 그리기 시작...');
                
                if (!this.spectrumCtx) {
                    console.error('❌ 스펙트럼 캔버스 컨텍스트가 없습니다!');
                    return;
                }
                
                const width = this.elements.spectrumChart.width;
                const height = this.elements.spectrumChart.height;
                
                console.log(`캔버스 크기: ${width} x ${height}`);
                
                // 배경 클리어
                this.spectrumCtx.clearRect(0, 0, width, height);
                
                // 배경
                this.spectrumCtx.fillStyle = '#1a1a1a';
                this.spectrumCtx.fillRect(0, 0, width, height);
                
                // 격자
                this.spectrumCtx.strokeStyle = '#444';
                this.spectrumCtx.lineWidth = 1;
                
                // 수직선
                for (let i = 0; i <= 10; i++) {
                    const x = (width * i) / 10;
                    this.spectrumCtx.beginPath();
                    this.spectrumCtx.moveTo(x, 0);
                    this.spectrumCtx.lineTo(x, height);
                    this.spectrumCtx.stroke();
                }
                
                // 수평선
                for (let i = 0; i <= 8; i++) {
                    const y = (height * i) / 8;
                    this.spectrumCtx.beginPath();
                    this.spectrumCtx.moveTo(0, y);
                    this.spectrumCtx.lineTo(width, y);
                    this.spectrumCtx.stroke();
                }
                
                console.log(`데이터 포인트 수: ${this.spectrumData.powers.length}`);
                
                // 스펙트럼 상태 업데이트
                if (this.elements.spectrumStatus) {
                    if (this.spectrumData.powers.length > 0) {
                        this.elements.spectrumStatus.textContent = `${this.spectrumData.powers.length}개 포인트`;
                    } else {
                        this.elements.spectrumStatus.textContent = '데이터 없음';
                    }
                }
                
                // 스펙트럼 데이터 그리기
                if (this.spectrumData.powers.length > 0) {
                    console.log('📈 스펙트럼 데이터 그리기 중...');
                    
                    const minPower = Math.min(...this.spectrumData.powers);
                    const maxPower = Math.max(...this.spectrumData.powers);
                    const powerRange = Math.max(maxPower - minPower, 10); // 최소 10dB 범위 보장
                    
                    console.log(`파워 범위: ${minPower.toFixed(1)} ~ ${maxPower.toFixed(1)} dBm (범위: ${powerRange.toFixed(1)})`);
                    
                    // 메인 스펙트럼 라인
                    this.spectrumCtx.strokeStyle = '#00ff00';
                    this.spectrumCtx.lineWidth = 2;
                    this.spectrumCtx.beginPath();
                    
                    let pointsDrawn = 0;
                    for (let i = 0; i < this.spectrumData.powers.length; i++) {
                        const x = (width * i) / Math.max(this.spectrumData.powers.length - 1, 1);
                        const normalizedPower = (this.spectrumData.powers[i] - minPower) / powerRange;
                        const y = height - (normalizedPower * height * 0.9) - height * 0.05; // 5% 여백
                        
                        if (i === 0) {
                            this.spectrumCtx.moveTo(x, y);
                            console.log(`첫 번째 포인트: (${x.toFixed(1)}, ${y.toFixed(1)}), power: ${this.spectrumData.powers[i].toFixed(1)}dBm`);
                        } else {
                            this.spectrumCtx.lineTo(x, y);
                        }
                        pointsDrawn++;
                    }
                    
                    this.spectrumCtx.stroke();
                    console.log(`✅ ${pointsDrawn}개 포인트 그리기 완료`);
                    
                    // 피크 마커
                    const maxIndex = this.spectrumData.powers.indexOf(maxPower);
                    const peakX = (width * maxIndex) / Math.max(this.spectrumData.powers.length - 1, 1);
                    const peakY = height - ((maxPower - minPower) / powerRange * height * 0.9) - height * 0.05;
                    
                    this.spectrumCtx.fillStyle = '#ff6600';
                    this.spectrumCtx.beginPath();
                    this.spectrumCtx.arc(peakX, peakY, 4, 0, 2 * Math.PI);
                    this.spectrumCtx.fill();
                    
                } else {
                    console.warn('⚠️ 스펙트럼 데이터가 없습니다!');
                    
                    // 데이터가 없을 때 표시
                    this.spectrumCtx.fillStyle = '#ff6666';
                    this.spectrumCtx.font = '16px Arial';
                    this.spectrumCtx.textAlign = 'center';
                    this.spectrumCtx.fillText('데이터 없음 - "테스트 데이터 생성" 클릭', width / 2, height / 2);
                }
                
                // 축 레이블
                this.spectrumCtx.fillStyle = '#fff';
                this.spectrumCtx.font = '12px Arial';
                this.spectrumCtx.textAlign = 'left';
                this.spectrumCtx.fillText('주파수 →', width - 80, height - 10);
                
                this.spectrumCtx.textAlign = 'left';
                this.spectrumCtx.fillText('↑', 5, 15);
                this.spectrumCtx.fillText('파워', 15, 15);
                this.spectrumCtx.fillText('(dBm)', 15, 30);
                
                console.log('✅ 스펙트럼 차트 그리기 완료');
            }

            updateMeasurements() {
                console.log('📊 측정값 업데이트 중...');
                
                if (this.spectrumData.powers.length > 0) {
                    const maxIndex = this.spectrumData.powers.indexOf(Math.max(...this.spectrumData.powers));
                    const peakFreq = this.spectrumData.frequencies[maxIndex];
                    const peakPower = this.spectrumData.powers[maxIndex];
                    
                    console.log(`Peak: ${(peakFreq/1e6).toFixed(3)} MHz, ${peakPower.toFixed(1)} dBm`);
                    
                    if (this.elements.peakFreq) {
                        this.elements.peakFreq.textContent = `${(peakFreq / 1e6).toFixed(3)} MHz`;
                    }
                    if (this.elements.peakPower) {
                        this.elements.peakPower.textContent = `${peakPower.toFixed(1)} dBm`;
                    }
                    if (this.elements.s11Value) {
                        this.elements.s11Value.textContent = `${(-15 + Math.random() * 10).toFixed(1)} dB`;
                    }
                    if (this.elements.vswr) {
                        this.elements.vswr.textContent = `${(1.1 + Math.random() * 0.5).toFixed(2)}`;
                    }
                    
                    console.log('✅ 측정값 업데이트 완료');
                } else {
                    console.log('⚠️ 데이터가 없어서 측정값을 업데이트할 수 없습니다');
                }
            }

            async startRealCapture() {
                console.log('실제 화면 캡처 시작...');
                // 실제 장비 캡처 로직 (간단 버전)
                this.isCapturing = true;
                // 실제 구현 시 여기에 캡처 코드 추가
            }

            // 기본 기능들
            setFrequencies() {
                const start = this.elements.startFreq?.value || 0.1;
                const stop = this.elements.stopFreq?.value || 350;
                const points = this.elements.points?.value || 101;
                
                this.logToTerminal(`📡 주파수 설정: ${start} - ${stop} MHz, ${points} 포인트`);
                
                // 새로운 설정으로 데이터 재생성
                this.generateSimulatedSpectrum();
                this.drawSpectrumChart();
                this.updateMeasurements();
            }

            startScan() {
                this.logToTerminal('📊 스펙트럼 스캔 시작...');
                this.setFrequencies();
            }

            startSweep() {
                this.logToTerminal('📈 S-parameter 측정 시작...');
                this.setFrequencies();
            }

            pauseCapture() {
                this.isPaused = true;
                this.logToTerminal('⏸️ 일시정지');
            }

            resumeCapture() {
                this.isPaused = false;
                this.logToTerminal('▶️ 재개');
            }

            calibrate() {
                this.logToTerminal('🎯 캘리브레이션 실행...');
            }

            saveCalibration() {
                this.logToTerminal('💾 캘리브레이션 저장...');
            }

            loadCalibration() {
                this.logToTerminal('📂 캘리브레이션 로드...');
            }

            saveData() {
                this.logToTerminal('💾 측정 데이터 저장...');
                const data = JSON.stringify(this.spectrumData, null, 2);
                this.downloadFile(data, 'spectrum_data.json', 'application/json');
            }

            saveImage() {
                this.logToTerminal('📸 스크린샷 저장...');
                const canvas = this.elements.screenCanvas;
                if (canvas) {
                    canvas.toBlob((blob) => {
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `screenshot_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.png`;
                        a.click();
                        URL.revokeObjectURL(url);
                    });
                }
            }

            exportCsv() {
                this.logToTerminal('📊 CSV 내보내기...');
                let csv = 'Frequency(Hz),Power(dBm)\n';
                for (let i = 0; i < this.spectrumData.frequencies.length; i++) {
                    csv += `${this.spectrumData.frequencies[i]},${this.spectrumData.powers[i]}\n`;
                }
                this.downloadFile(csv, 'spectrum_data.csv', 'text/csv');
            }

            systemReset() {
                this.logToTerminal('🔄 시스템 리셋...');
                // 데이터 초기화
                this.spectrumData = { frequencies: [], powers: [] };
                this.drawSpectrumChart();
                this.updateMeasurements();
            }

            checkBattery() {
                this.logToTerminal('🔋 배터리 체크...');
                setTimeout(() => {
                    this.logToTerminal('🔋 배터리: 3.7V (82%)');
                }, 500);
            }

            getDeviceInfo() {
                this.logToTerminal('ℹ️ 장비 정보 조회...');
                setTimeout(() => {
                    this.logToTerminal(`ℹ️ ${this.getDeviceConfig().name} 시뮬레이션 버전 v1.1`);
                    this.logToTerminal(`ℹ️ 측정 범위: 100kHz - ${this.getDeviceConfig().maxFreq}MHz`);
                }, 500);
            }

            sendCommand() {
                const command = this.elements.commandInput?.value?.trim();
                if (command) {
                    this.logToTerminal(`💻 명령: ${command}`);
                    this.elements.commandInput.value = '';
                    
                    // 간단한 시뮬레이션 응답
                    setTimeout(() => {
                        if (command.toLowerCase() === 'help') {
                            this.logToTerminal('📥 사용 가능한 명령어: scan, sweep, cal, info, reset');
                        } else {
                            this.logToTerminal(`📥 응답: OK - "${command}" 실행됨`);
                        }
                    }, 300);
                }
            }

            handleScreenClick(event) {
                if (!this.isConnected) return;
                
                const rect = this.elements.screenCanvas.getBoundingClientRect();
                const x = Math.floor((event.clientX - rect.left) * (this.elements.screenCanvas.width / rect.width));
                const y = Math.floor((event.clientY - rect.top) * (this.elements.screenCanvas.height / rect.height));
                
                this.logToTerminal(`👆 터치: (${x}, ${y})`);
            }

            updateFPS() {
                this.frameCount++;
                const now = Date.now();
                
                if (now - this.lastFpsUpdate >= 1000) {
                    this.fps = this.frameCount;
                    this.frameCount = 0;
                    this.lastFpsUpdate = now;
                    
                    if (this.elements.fpsDisplay) {
                        this.elements.fpsDisplay.textContent = this.fps.toString();
                    }
                }
            }

            downloadFile(content, filename, contentType) {
                const blob = new Blob([content], { type: contentType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
            }

            logToTerminal(message) {
                console.log(message);
                
                if (this.elements.terminal) {
                    const timestamp = new Date().toLocaleTimeString();
                    const line = document.createElement('div');
                    line.className = 'terminal-line';
                    line.textContent = `[${timestamp}] ${message}`;
                    this.elements.terminal.appendChild(line);
                    this.elements.terminal.scrollTop = this.elements.terminal.scrollHeight;
                    
                    // 로그 라인 수 제한
                    const lines = this.elements.terminal.children;
                    if (lines.length > 50) {
                        lines[0].remove();
                    }
                }
            }
        }

        // 애플리케이션 시작
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM 로드 완료');
            
            try {
                window.controller = new TinySAController();
                console.log('✅ 애플리케이션 시작 성공');
            } catch (error) {
                console.error('❌ 애플리케이션 시작 실패:', error);
            }
        });
    </script>
</body>
</html>
