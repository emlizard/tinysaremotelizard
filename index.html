<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì™„ì „í•œ tinySA Ultra ì›¹ ì»¨íŠ¸ë¡¤ëŸ¬</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0f23, #1a1a3a);
            color: #fff;
            min-height: 100vh;
            overflow-x: auto;
        }

        .header {
            background: rgba(0, 0, 0, 0.4);
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            position: relative;
            z-index: 100;
        }

        .header h1 {
            font-size: 1.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .device-selector {
            padding: 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #f44336;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #4caf50;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .main-container {
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            gap: 1rem;
            height: calc(100vh - 80px);
            padding: 1rem;
        }

        .left-panel, .right-panel {
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 1rem;
            overflow-y: auto;
        }

        .center-area {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .display-area {
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 1rem;
            position: relative;
        }

        .tab-container {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .tab-button {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px 8px 0 0;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab-button.active {
            background: linear-gradient(45deg, #42a5f5, #1976d2);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .device-screen {
            background: #000;
            border: 3px solid #333;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
            position: relative;
            cursor: crosshair;
            transition: transform 0.3s ease;
            margin: 0 auto;
        }

        .device-screen canvas {
            display: block;
            border-radius: 7px;
        }

        .screen-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #fff;
            font-size: 1.2rem;
            border-radius: 7px;
        }

        .section {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section h3 {
            color: #64b5f6;
            margin-bottom: 1rem;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .input-group {
            margin-bottom: 1rem;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #e3f2fd;
            font-size: 0.9rem;
        }

        input, select, button {
            width: 100%;
            padding: 0.6rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #64b5f6;
            box-shadow: 0 0 10px rgba(100, 181, 246, 0.3);
        }

        button {
            background: linear-gradient(45deg, #42a5f5, #1976d2);
            border: none;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
        }

        button:hover {
            background: linear-gradient(45deg, #1976d2, #1565c0);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(25, 118, 210, 0.4);
        }

        button:disabled {
            background: rgba(255, 255, 255, 0.1);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .chart-container {
            width: 100%;
            height: 300px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            margin-bottom: 1rem;
            position: relative;
        }

        .chart-container canvas {
            border-radius: 8px;
            background: #1a1a1a;
        }

        .measurement-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .measurement-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.8rem;
            border-radius: 8px;
            text-align: center;
        }

        .measurement-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #64b5f6;
            margin-bottom: 0.3rem;
        }

        .measurement-label {
            font-size: 0.8rem;
            color: #e3f2fd;
        }

        .frequency-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .terminal {
            background: #000;
            color: #0f0;
            font-family: 'Courier New', monospace;
            padding: 1rem;
            border-radius: 8px;
            height: 150px;
            overflow-y: auto;
            font-size: 0.75rem;
            border: 1px solid #333;
        }

        .terminal-line {
            margin-bottom: 0.2rem;
        }

        .data-table {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
        }

        .data-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 0.5rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.8rem;
        }

        .data-table th {
            background: rgba(255, 255, 255, 0.1);
            font-weight: bold;
            color: #64b5f6;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #42a5f5, #1976d2);
            width: 0%;
            transition: width 0.3s ease;
        }

        .smith-chart {
            width: 250px;
            height: 250px;
            margin: 0 auto;
            position: relative;
        }

        .frequency-marker {
            position: absolute;
            width: 20px;
            height: 20px;
            background: #ff0;
            border-radius: 50%;
            cursor: pointer;
            transform: translate(-50%, -50%);
        }

        .zoom-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .zoom-btn {
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .zoom-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .command-history {
            max-height: 100px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            padding: 0.5rem;
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .file-input {
            margin-bottom: 0.5rem;
        }

        .file-input input[type="file"] {
            padding: 0.3rem;
            font-size: 0.8rem;
        }

        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto;
            }
            
            .left-panel, .right-panel {
                height: auto;
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.2rem;
            }
            
            .controls {
                flex-direction: column;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ”¬ ì™„ì „í•œ tinySA Ultra ì›¹ ì»¨íŠ¸ë¡¤ëŸ¬</h1>
        <div class="controls">
            <select class="device-selector" id="deviceType">
                <option value="tinysa-ultra">tinySA Ultra</option>
                <option value="tinysa">tinySA</option>
                <option value="nanovna">NanoVNA-H</option>
                <option value="nanovna-h4">NanoVNA-H4</option>
                <option value="tinypfa">tinyPFA</option>
            </select>
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <span id="connectionStatus">ì—°ê²° ì•ˆë¨</span>
            </div>
        </div>
    </div>

    <!-- Chrome í™•ì¥ í”„ë¡œê·¸ë¨ ì¶©ëŒ ì•Œë¦¼ -->
    <div id="extensionWarning" style="
        background: linear-gradient(45deg, #ff9800, #f57c00);
        color: white;
        padding: 0.5rem 1rem;
        text-align: center;
        font-size: 0.9rem;
        display: none;
        border-bottom: 1px solid rgba(255,255,255,0.2);
    ">
        âš ï¸ Chrome í™•ì¥ í”„ë¡œê·¸ë¨ ì¶©ëŒì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. 
        <button onclick="this.parentElement.style.display='none'" style="
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            margin: 0 0.5rem;
            cursor: pointer;
        ">ë‹«ê¸°</button>
        <a href="#" onclick="showExtensionHelp()" style="
            color: white;
            text-decoration: underline;
            margin-left: 0.5rem;
        ">í•´ê²°ë°©ë²• ë³´ê¸°</a>
    </div>

    <div class="main-container">
        <!-- ì™¼ìª½ ì œì–´ íŒ¨ë„ -->
        <div class="left-panel">
            <!-- ì—°ê²° ìƒíƒœ -->
            <div class="section">
                <h3>ğŸ”Œ ì¥ë¹„ ì—°ê²°</h3>
                <button id="connectBtn">ì¥ë¹„ ì—°ê²°</button>
                <button id="disconnectBtn" disabled>ì—°ê²° í•´ì œ</button>
                <div class="input-group">
                    <label>ì—°ê²° ìƒíƒœ</label>
                    <div id="deviceInfo" style="font-size: 0.8rem; color: #ccc;">
                        <div>í•´ìƒë„: <span id="resolution">480Ã—320</span></div>
                        <div>FPS: <span id="fpsValue">0</span></div>
                        <div>ë°°í„°ë¦¬: <span id="battery">-</span></div>
                    </div>
                </div>
            </div>

            <!-- ì£¼íŒŒìˆ˜ ì„¤ì • -->
            <div class="section">
                <h3>ğŸ“¡ ì£¼íŒŒìˆ˜ ì„¤ì •</h3>
                <div class="frequency-controls">
                    <div class="input-group">
                        <label>ì‹œì‘ (MHz)</label>
                        <input type="number" id="startFreq" value="0.1" step="0.1">
                    </div>
                    <div class="input-group">
                        <label>ì¢…ë£Œ (MHz)</label>
                        <input type="number" id="stopFreq" value="350" step="0.1">
                    </div>
                </div>
                <div class="input-group">
                    <label>ì¸¡ì • í¬ì¸íŠ¸</label>
                    <select id="points">
                        <option value="101">101</option>
                        <option value="201">201</option>
                        <option value="401">401</option>
                        <option value="801">801</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>RBW (kHz)</label>
                    <select id="rbw">
                        <option value="auto">ìë™</option>
                        <option value="1">1</option>
                        <option value="3">3</option>
                        <option value="10">10</option>
                        <option value="30">30</option>
                        <option value="100">100</option>
                    </select>
                </div>
                <button id="setFreqBtn">ì£¼íŒŒìˆ˜ ì„¤ì •</button>
            </div>

            <!-- ìŠ¤ìº” ì œì–´ -->
            <div class="section">
                <h3>ğŸ” ìŠ¤ìº” ì œì–´</h3>
                <button id="scanBtn">ìŠ¤í™íŠ¸ëŸ¼ ìŠ¤ìº”</button>
                <button id="sweepBtn">ìŠ¤ìœ„í”„ ì¸¡ì •</button>
                <button id="pauseBtn" disabled>ì¼ì‹œ ì •ì§€</button>
                <button id="resumeBtn" disabled>ì¬ê°œ</button>
                <button id="singleSweepBtn">ë‹¨ì¼ ìŠ¤ìœ„í”„</button>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div id="scanStatus" style="font-size: 0.8rem; color: #ccc;">ëŒ€ê¸° ì¤‘</div>
            </div>

            <!-- ì¸¡ì • ëª¨ë“œ -->
            <div class="section">
                <h3>âš™ï¸ ì¸¡ì • ëª¨ë“œ</h3>
                <div class="input-group">
                    <label>ì¸¡ì • íƒ€ì…</label>
                    <select id="measurementType">
                        <option value="spectrum">ìŠ¤í™íŠ¸ëŸ¼</option>
                        <option value="s11">S11 (ë°˜ì‚¬)</option>
                        <option value="s21">S21 (íˆ¬ê³¼)</option>
                        <option value="s11s21">S11 + S21</option>
                        <option value="z">Z-parameter</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>ì°¸ì¡° ë ˆë²¨ (dBm)</label>
                    <input type="number" id="refLevel" value="-10" step="1">
                </div>
                <div class="input-group">
                    <label>ìŠ¤ì¼€ì¼ (dB/div)</label>
                    <select id="scale">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="5">5</option>
                        <option value="10">10</option>
                    </select>
                </div>
            </div>

            <!-- ìº˜ë¦¬ë¸Œë ˆì´ì…˜ -->
            <div class="section">
                <h3>ğŸ¯ ìº˜ë¦¬ë¸Œë ˆì´ì…˜</h3>
                <button id="calOpenBtn">OPEN ìº˜ë¦¬ë¸Œë ˆì´ì…˜</button>
                <button id="calShortBtn">SHORT ìº˜ë¦¬ë¸Œë ˆì´ì…˜</button>
                <button id="calLoadBtn">LOAD ìº˜ë¦¬ë¸Œë ˆì´ì…˜</button>
                <button id="calThroughBtn">THROUGH ìº˜ë¦¬ë¸Œë ˆì´ì…˜</button>
                <button id="saveCalBtn">ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì €ì¥</button>
                <button id="recallCalBtn">ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ë¡œë“œ</button>
                <button id="clearCalBtn">ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì´ˆê¸°í™”</button>
            </div>
        </div>

        <!-- ì¤‘ì•™ ë””ìŠ¤í”Œë ˆì´ ì˜ì—­ -->
        <div class="center-area">
            <div class="tab-container">
                <button class="tab-button active" data-tab="screen">í™”ë©´ ë¯¸ëŸ¬ë§</button>
                <button class="tab-button" data-tab="spectrum">ìŠ¤í™íŠ¸ëŸ¼</button>
                <button class="tab-button" data-tab="smith">Smith ì°¨íŠ¸</button>
                <button class="tab-button" data-tab="data">ë°ì´í„°</button>
            </div>

            <div class="display-area">
                <!-- í™”ë©´ ë¯¸ëŸ¬ë§ íƒ­ -->
                <div id="screen-tab" class="tab-content active">
                    <div class="device-screen" id="deviceScreen">
                        <canvas id="screenCanvas" width="480" height="320"></canvas>
                        <div class="screen-overlay" id="screenOverlay">
                            <div>ğŸ”Œ ì¥ë¹„ë¥¼ ì—°ê²°í•˜ì„¸ìš”</div>
                            <div style="font-size: 0.9rem; margin-top: 1rem; opacity: 0.7;">
                                HTTPS í™˜ê²½ì—ì„œ ì‹¤ì œ ì¥ë¹„ ì—°ê²° ê°€ëŠ¥
                            </div>
                        </div>
                    </div>
                    
                    <div class="zoom-controls">
                        <button class="zoom-btn" id="zoomIn" title="í™•ëŒ€ (+)">+</button>
                        <button class="zoom-btn" id="zoomOut" title="ì¶•ì†Œ (-)">-</button>
                        <button class="zoom-btn" id="screenshot" title="ìŠ¤í¬ë¦°ìƒ· (S)">ğŸ“·</button>
                    </div>

                    <div style="text-align: center; margin-top: 1rem; font-size: 0.9rem;">
                        í™”ë©´ì„ í´ë¦­í•˜ì—¬ ì¥ë¹„ ì¡°ì‘ | í‚¤ë³´ë“œ: +/- ì¤Œ, S ìŠ¤í¬ë¦°ìƒ·, ESC ì¢…ë£Œ
                    </div>
                </div>

                <!-- ìŠ¤í™íŠ¸ëŸ¼ íƒ­ -->
                <div id="spectrum-tab" class="tab-content">
                    <div class="chart-container">
                        <canvas id="spectrumChart" width="800" height="280"></canvas>
                    </div>
                    <div class="measurement-grid">
                        <div class="measurement-card">
                            <div class="measurement-value" id="peakFreq">-</div>
                            <div class="measurement-label">Peak ì£¼íŒŒìˆ˜</div>
                        </div>
                        <div class="measurement-card">
                            <div class="measurement-value" id="peakPower">-</div>
                            <div class="measurement-label">Peak íŒŒì›Œ</div>
                        </div>
                        <div class="measurement-card">
                            <div class="measurement-value" id="avgPower">-</div>
                            <div class="measurement-label">í‰ê·  íŒŒì›Œ</div>
                        </div>
                        <div class="measurement-card">
                            <div class="measurement-value" id="noiseFloor">-</div>
                            <div class="measurement-label">ë…¸ì´ì¦ˆ í”Œë¡œì–´</div>
                        </div>
                    </div>
                </div>

                <!-- Smith ì°¨íŠ¸ íƒ­ -->
                <div id="smith-tab" class="tab-content">
                    <div class="smith-chart">
                        <canvas id="smithChart" width="250" height="250"></canvas>
                    </div>
                    <div class="measurement-grid">
                        <div class="measurement-card">
                            <div class="measurement-value" id="vswr">-</div>
                            <div class="measurement-label">VSWR</div>
                        </div>
                        <div class="measurement-card">
                            <div class="measurement-value" id="returnLoss">-</div>
                            <div class="measurement-label">Return Loss</div>
                        </div>
                        <div class="measurement-card">
                            <div class="measurement-value" id="impedance">-</div>
                            <div class="measurement-label">ì„í”¼ë˜ìŠ¤</div>
                        </div>
                        <div class="measurement-card">
                            <div class="measurement-value" id="phase">-</div>
                            <div class="measurement-label">ìœ„ìƒ</div>
                        </div>
                    </div>
                </div>

                <!-- ë°ì´í„° íƒ­ -->
                <div id="data-tab" class="tab-content">
                    <div class="data-table">
                        <table id="dataTable">
                            <thead>
                                <tr>
                                    <th>ì£¼íŒŒìˆ˜ (MHz)</th>
                                    <th>S11 (dB)</th>
                                    <th>S21 (dB)</th>
                                    <th>ìœ„ìƒ (Â°)</th>
                                </tr>
                            </thead>
                            <tbody id="dataTableBody">
                                <tr><td colspan="4">ë°ì´í„° ì—†ìŒ</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì˜¤ë¥¸ìª½ ì œì–´ íŒ¨ë„ -->
        <div class="right-panel">
            <!-- ë§ˆì»¤ ì œì–´ -->
            <div class="section">
                <h3>ğŸ“ ë§ˆì»¤ ì œì–´</h3>
                <div class="input-group">
                    <label>ë§ˆì»¤ ì£¼íŒŒìˆ˜ (MHz)</label>
                    <input type="number" id="markerFreq" value="100" step="0.1">
                </div>
                <button id="setMarkerBtn">ë§ˆì»¤ ì„¤ì •</button>
                <button id="markerPeakBtn">Peak ë§ˆì»¤</button>
                <button id="clearMarkersBtn">ë§ˆì»¤ ì‚­ì œ</button>
                <div id="markerInfo" style="font-size: 0.8rem; color: #ccc; margin-top: 0.5rem;">
                    ë§ˆì»¤ ì—†ìŒ
                </div>
            </div>

            <!-- ë°ì´í„° ì €ì¥/ë¡œë“œ -->
            <div class="section">
                <h3>ğŸ’¾ ë°ì´í„° ê´€ë¦¬</h3>
                <button id="saveDataBtn">ì¸¡ì • ë°ì´í„° ì €ì¥</button>
                <button id="saveTouchstoneBtn">Touchstone ì €ì¥</button>
                <button id="saveImageBtn">ì´ë¯¸ì§€ ì €ì¥</button>
                <div class="file-input">
                    <input type="file" id="loadDataBtn" accept=".s1p,.s2p,.csv" style="width: 100%;">
                </div>
                <button id="exportCSVBtn">CSV ë‚´ë³´ë‚´ê¸°</button>
            </div>

            <!-- ê³ ê¸‰ ì¸¡ì • -->
            <div class="section">
                <h3>ğŸ”¬ ê³ ê¸‰ ì¸¡ì •</h3>
                <button id="tdTimeBtn">ì‹œê°„ ë„ë©”ì¸ ë³€í™˜</button>
                <button id="noiseAnalysisBtn">ë…¸ì´ì¦ˆ ë¶„ì„</button>
                <button id="harmonicBtn">ê³ ì¡°íŒŒ ë¶„ì„</button>
                <button id="spuriousBtn">ìŠ¤í“¨ë¦¬ì–´ìŠ¤ ë¶„ì„</button>
                <button id="powerMeterBtn">íŒŒì›Œ ë¯¸í„°</button>
            </div>

            <!-- ì‹œìŠ¤í…œ ì œì–´ -->
            <div class="section">
                <h3>ğŸ”§ ì‹œìŠ¤í…œ</h3>
                <button id="resetBtn">ì‹œìŠ¤í…œ ë¦¬ì…‹</button>
                <button id="vbatBtn">ë°°í„°ë¦¬ ì²´í¬</button>
                <button id="timeBtn">ì‹œê°„ ë™ê¸°í™”</button>
                <button id="infoBtn">ì¥ë¹„ ì •ë³´</button>
                <button id="versionBtn">íŒì›¨ì–´ ë²„ì „</button>
            </div>

            <!-- ëª…ë ¹ì–´ ì¸í„°í˜ì´ìŠ¤ -->
            <div class="section">
                <h3>ğŸ’» ëª…ë ¹ì–´</h3>
                <div class="command-history" id="commandHistory">
                    ëª…ë ¹ì–´ ê¸°ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
                </div>
                <div class="input-group">
                    <input type="text" id="commandInput" placeholder="ëª…ë ¹ì–´ ì…ë ¥..." value="help">
                </div>
                <button id="sendCommandBtn">ëª…ë ¹ ì „ì†¡</button>
                <button id="helpBtn">ëª…ë ¹ì–´ ë„ì›€ë§</button>
            </div>

            <!-- í†µì‹  ë¡œê·¸ -->
            <div class="section">
                <h3>ğŸ“Ÿ í†µì‹  ë¡œê·¸</h3>
                <div class="terminal" id="terminal">
                    <div class="terminal-line">ì™„ì „í•œ tinySA Ultra ì›¹ ì»¨íŠ¸ë¡¤ëŸ¬ v2.0</div>
                    <div class="terminal-line">ëª¨ë“  ê¸°ëŠ¥ì´ í¬í•¨ëœ ë²„ì „ì…ë‹ˆë‹¤.</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class CompleteTinySAController {
            constructor() {
                this.isConnected = false;
                this.serialPort = null;
                this.deviceType = 'tinysa-ultra';
                this.zoom = 2;
                this.isCapturing = false;
                this.isPaused = false;
                this.invertColors = false;
                this.fps = 0;
                this.frameCount = 0;
                this.lastFpsUpdate = Date.now();
                this.screenData = null;
                this.simulationMode = !('serial' in navigator) || window.location.protocol !== 'https:';
                this.availableDevices = [];
                this.currentTab = 'screen';
                
                // ì¸¡ì • ë°ì´í„°
                this.spectrumData = {
                    frequencies: [],
                    powers: [],
                    s11: [],
                    s21: [],
                    phases: []
                };
                
                // ë§ˆì»¤ ë°ì´í„°
                this.markers = [];
                this.calibrationData = null;
                
                this.initializeWhenReady();
            }

            async initializeWhenReady() {
                let retries = 0;
                while (retries < 10) {
                    try {
                        this.canvas = document.getElementById('screenCanvas');
                        if (!this.canvas) {
                            retries++;
                            await new Promise(resolve => setTimeout(resolve, 100));
                            continue;
                        }
                        
                        this.ctx = this.canvas.getContext('2d');
                        this.spectrumCanvas = document.getElementById('spectrumChart');
                        this.spectrumCtx = this.spectrumCanvas.getContext('2d');
                        this.smithCanvas = document.getElementById('smithChart');
                        this.smithCtx = this.smithCanvas.getContext('2d');
                        
                        this.initializeElements();
                        this.setupEventListeners();
                        this.setupKeyboardShortcuts();
                        this.updateDeviceResolution();
                        this.checkWebSerialSupport();
                        
                        this.logToTerminal('âœ… ì™„ì „í•œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ˆê¸°í™” ì™„ë£Œ');
                        
                        if (this.simulationMode) {
                            this.startSimulation();
                        } else {
                            this.startDeviceMonitoring();
                        }
                        
                        // ê¸°ë³¸ ì°¨íŠ¸ ê·¸ë¦¬ê¸°
                        this.drawSpectrumChart();
                        this.drawSmithChart();
                        
                        break;
                    } catch (error) {
                        console.error('ì´ˆê¸°í™” ì‹œë„ ì‹¤íŒ¨:', error);
                        retries++;
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                }
                
                if (retries >= 10) {
                    console.error('ì´ˆê¸°í™” ì‹¤íŒ¨: DOM ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }
            }

            initializeElements() {
                const elementIds = [
                    'deviceType', 'statusDot', 'connectionStatus', 'deviceScreen', 'screenOverlay',
                    'resolution', 'fpsValue', 'battery', 'connectBtn', 'disconnectBtn',
                    'startFreq', 'stopFreq', 'points', 'rbw', 'setFreqBtn', 'refLevel', 'scale',
                    'scanBtn', 'sweepBtn', 'pauseBtn', 'resumeBtn', 'singleSweepBtn',
                    'progressFill', 'scanStatus', 'measurementType',
                    'calOpenBtn', 'calShortBtn', 'calLoadBtn', 'calThroughBtn',
                    'saveCalBtn', 'recallCalBtn', 'clearCalBtn',
                    'zoomIn', 'zoomOut', 'screenshot',
                    'peakFreq', 'peakPower', 'avgPower', 'noiseFloor',
                    'vswr', 'returnLoss', 'impedance', 'phase',
                    'dataTableBody', 'markerFreq', 'setMarkerBtn', 'markerPeakBtn',
                    'clearMarkersBtn', 'markerInfo', 'saveDataBtn', 'saveTouchstoneBtn',
                    'saveImageBtn', 'loadDataBtn', 'exportCSVBtn',
                    'tdTimeBtn', 'noiseAnalysisBtn', 'harmonicBtn', 'spuriousBtn', 'powerMeterBtn',
                    'resetBtn', 'vbatBtn', 'timeBtn', 'infoBtn', 'versionBtn',
                    'commandHistory', 'commandInput', 'sendCommandBtn', 'helpBtn', 'terminal'
                ];
                
                this.elements = {};
                elementIds.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        this.elements[id] = element;
                    } else {
                        console.warn(`ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${id}`);
                    }
                });
                
                console.log(`ì´ˆê¸°í™”ëœ ìš”ì†Œ: ${Object.keys(this.elements).length}/${elementIds.length}`);
            }

            setupEventListeners() {
                const addSafeListener = (elementId, event, handler) => {
                    const element = this.elements[elementId];
                    if (element) {
                        element.addEventListener(event, handler);
                    } else {
                        console.warn(`ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ ì‹¤íŒ¨: ${elementId} ìš”ì†Œê°€ ì—†ìŠµë‹ˆë‹¤`);
                    }
                };

                // ê¸°ë³¸ ì œì–´
                addSafeListener('deviceType', 'change', (e) => {
                    this.deviceType = e.target.value;
                    this.updateDeviceResolution();
                });

                addSafeListener('connectBtn', 'click', () => this.connect());
                addSafeListener('disconnectBtn', 'click', () => this.disconnect());

                // ì£¼íŒŒìˆ˜ ì œì–´
                addSafeListener('setFreqBtn', 'click', () => this.setFrequencies());

                // ìŠ¤ìº” ì œì–´
                addSafeListener('scanBtn', 'click', () => this.startSpectrumScan());
                addSafeListener('sweepBtn', 'click', () => this.startSweep());
                addSafeListener('pauseBtn', 'click', () => this.pauseCapture());
                addSafeListener('resumeBtn', 'click', () => this.resumeCapture());
                addSafeListener('singleSweepBtn', 'click', () => this.singleSweep());

                // ìº˜ë¦¬ë¸Œë ˆì´ì…˜
                addSafeListener('calOpenBtn', 'click', () => this.calibrateOpen());
                addSafeListener('calShortBtn', 'click', () => this.calibrateShort());
                addSafeListener('calLoadBtn', 'click', () => this.calibrateLoad());
                addSafeListener('calThroughBtn', 'click', () => this.calibrateThrough());
                addSafeListener('saveCalBtn', 'click', () => this.saveCalibration());
                addSafeListener('recallCalBtn', 'click', () => this.recallCalibration());
                addSafeListener('clearCalBtn', 'click', () => this.clearCalibration());

                // í™”ë©´ ì œì–´
                addSafeListener('zoomIn', 'click', () => this.zoomIn());
                addSafeListener('zoomOut', 'click', () => this.zoomOut());
                addSafeListener('screenshot', 'click', () => this.takeScreenshot());

                // ë§ˆì»¤ ì œì–´
                addSafeListener('setMarkerBtn', 'click', () => this.setMarker());
                addSafeListener('markerPeakBtn', 'click', () => this.setPeakMarker());
                addSafeListener('clearMarkersBtn', 'click', () => this.clearMarkers());

                // ë°ì´í„° ê´€ë¦¬
                addSafeListener('saveDataBtn', 'click', () => this.saveData());
                addSafeListener('saveTouchstoneBtn', 'click', () => this.saveTouchstone());
                addSafeListener('saveImageBtn', 'click', () => this.saveImage());
                addSafeListener('exportCSVBtn', 'click', () => this.exportCSV());
                addSafeListener('loadDataBtn', 'change', (e) => this.loadData(e));

                // ê³ ê¸‰ ì¸¡ì •
                addSafeListener('tdTimeBtn', 'click', () => this.timeDomainTransform());
                addSafeListener('noiseAnalysisBtn', 'click', () => this.noiseAnalysis());
                addSafeListener('harmonicBtn', 'click', () => this.harmonicAnalysis());
                addSafeListener('spuriousBtn', 'click', () => this.spuriousAnalysis());
                addSafeListener('powerMeterBtn', 'click', () => this.powerMeter());

                // ì‹œìŠ¤í…œ ì œì–´
                addSafeListener('resetBtn', 'click', () => this.systemReset());
                addSafeListener('vbatBtn', 'click', () => this.checkBattery());
                addSafeListener('timeBtn', 'click', () => this.syncTime());
                addSafeListener('infoBtn', 'click', () => this.getDeviceInfo());
                addSafeListener('versionBtn', 'click', () => this.getFirmwareVersion());

                // ëª…ë ¹ì–´
                addSafeListener('sendCommandBtn', 'click', () => this.sendCommand());
                addSafeListener('helpBtn', 'click', () => this.showHelp());
                addSafeListener('commandInput', 'keypress', (e) => {
                    if (e.key === 'Enter') this.sendCommand();
                });

                // íƒ­ ì œì–´
                document.querySelectorAll('.tab-button').forEach(button => {
                    button.addEventListener('click', () => this.switchTab(button.dataset.tab));
                });

                // í™”ë©´ í´ë¦­
                if (this.canvas) {
                    this.canvas.addEventListener('click', (e) => this.handleScreenClick(e));
                    this.canvas.addEventListener('mousemove', (e) => this.handleMouseMove(e));
                }
            }

            setupKeyboardShortcuts() {
                document.addEventListener('keydown', (e) => {
                    switch (e.key) {
                        case '+':
                        case '=':
                            e.preventDefault();
                            this.zoomIn();
                            break;
                        case '-':
                            e.preventDefault();
                            this.zoomOut();
                            break;
                        case 's':
                        case 'S':
                            e.preventDefault();
                            this.takeScreenshot();
                            break;
                        case 'Escape':
                            e.preventDefault();
                            this.disconnect();
                            break;
                        case ' ':
                            e.preventDefault();
                            if (this.isPaused) {
                                this.resumeCapture();
                            } else {
                                this.pauseCapture();
                            }
                            break;
                    }
                });
            }

            getDeviceConfig() {
                const configs = {
                    'nanovna': {
                        name: 'NanoVNA-H',
                        vendorId: 0x0483,
                        productId: 0x5740,
                        baudRate: 115200,
                        width: 320,
                        height: 240,
                        hasRLE: false,
                        maxFreq: 900e6
                    },
                    'nanovna-h4': {
                        name: 'NanoVNA-H4',
                        vendorId: 0x0483,
                        productId: 0x5740,
                        baudRate: 115200,
                        width: 480,
                        height: 320,
                        hasRLE: false,
                        maxFreq: 1.5e9
                    },
                    'tinysa': {
                        name: 'tinySA',
                        vendorId: 0x0483,
                        productId: 0x5740,
                        baudRate: 115200,
                        width: 320,
                        height: 240,
                        hasRLE: true,
                        maxFreq: 350e6
                    },
                    'tinysa-ultra': {
                        name: 'tinySA Ultra',
                        vendorId: 0x0483,
                        productId: 0x5740,
                        baudRate: 115200,
                        width: 480,
                        height: 320,
                        hasRLE: true,
                        maxFreq: 5.3e9
                    },
                    'tinypfa': {
                        name: 'tinyPFA',
                        vendorId: 0x0483,
                        productId: 0x5740,
                        baudRate: 115200,
                        width: 320,
                        height: 240,
                        hasRLE: false,
                        maxFreq: 6e9
                    }
                };
                return configs[this.deviceType];
            }

            updateDeviceResolution() {
                const deviceConfig = this.getDeviceConfig();
                
                this.canvas.width = deviceConfig.width;
                this.canvas.height = deviceConfig.height;
                if (this.elements.resolution) {
                    this.elements.resolution.textContent = `${deviceConfig.width}Ã—${deviceConfig.height}`;
                }
                
                const headerTitle = document.querySelector('.header h1');
                headerTitle.textContent = `ğŸ”¬ ${deviceConfig.name} ì™„ì „ ì›¹ ì»¨íŠ¸ë¡¤ëŸ¬`;
                
                this.updateScreenSize();
                this.logToTerminal(`ì¥ë¹„ ë³€ê²½: ${deviceConfig.name} (${deviceConfig.width}Ã—${deviceConfig.height})`);
            }

            updateScreenSize() {
                const scale = this.zoom;
                if (this.elements.deviceScreen) {
                    this.elements.deviceScreen.style.transform = `scale(${scale})`;
                }
            }

            checkWebSerialSupport() {
                try {
                    if ('serial' in navigator) {
                        if (window.location.protocol === 'https:' || 
                            window.location.hostname === 'localhost' || 
                            window.location.hostname === '127.0.0.1') {
                            this.simulationMode = false;
                            this.logToTerminal('âœ… WebSerial API ì§€ì›ë¨ - ì‹¤ì œ ì¥ë¹„ ì—°ê²° ê°€ëŠ¥');
                        } else {
                            this.simulationMode = true;
                            this.logToTerminal('âš ï¸  WebSerial API ì§€ì›ë˜ì§€ë§Œ HTTP í™˜ê²½ìœ¼ë¡œ ì œí•œë¨');
                            this.logToTerminal('ğŸ”’ HTTPS í™˜ê²½ì—ì„œ ì‹¤ì œ ì¥ë¹„ ì—°ê²° ê°€ëŠ¥');
                        }
                    } else {
                        this.simulationMode = true;
                        this.logToTerminal('âŒ WebSerial API ë¯¸ì§€ì› - ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œë¡œ ë™ì‘');
                        this.logToTerminal('ğŸ’¡ Chrome/Edge ë¸Œë¼ìš°ì €ì™€ HTTPS í™˜ê²½ì—ì„œ ì‚¬ìš©í•˜ì„¸ìš”');
                    }
                } catch (error) {
                    console.warn('WebSerial ì§€ì› í™•ì¸ ì¤‘ ì˜¤ë¥˜:', error);
                    this.simulationMode = true;
                    this.logToTerminal('âš ï¸  WebSerial í™•ì¸ ì‹¤íŒ¨ - ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œë¡œ ì „í™˜');
                }
                
                if (this.simulationMode) {
                    this.logToTerminal('ğŸ® í˜„ì¬ ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œì—ì„œ ëª¨ë“  ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥');
                }
            }

            async startDeviceMonitoring() {
                if ('serial' in navigator) {
                    navigator.serial.addEventListener('connect', (event) => {
                        this.logToTerminal('ì¥ë¹„ ì—°ê²°ë¨');
                    });
                    
                    navigator.serial.addEventListener('disconnect', (event) => {
                        this.logToTerminal('ì¥ë¹„ ì—°ê²° í•´ì œë¨');
                        if (event.port === this.serialPort) {
                            this.disconnect();
                        }
                    });
                }
            }

            async connect() {
                this.elements.connectBtn.disabled = true;
                this.elements.connectionStatus.textContent = 'ì—°ê²° ì‹œë„ ì¤‘...';
                this.logToTerminal('ğŸ”Œ ì¥ë¹„ ì—°ê²° ì‹œì‘...');
                
                const deviceConfig = this.getDeviceConfig();
                this.logToTerminal(`ì„ íƒëœ ì¥ë¹„: ${deviceConfig.name}`);

                if (!this.simulationMode) {
                    try {
                        // Chrome í™•ì¥ í”„ë¡œê·¸ë¨ ì¶©ëŒ ë°©ì§€ë¥¼ ìœ„í•œ ì§€ì—°
                        await new Promise(resolve => setTimeout(resolve, 200));
                        
                        this.logToTerminal('ğŸ“‹ ì¥ë¹„ ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ...');
                        
                        this.serialPort = await Promise.race([
                            navigator.serial.requestPort({
                                filters: [{ 
                                    usbVendorId: deviceConfig.vendorId, 
                                    usbProductId: deviceConfig.productId 
                                }]
                            }),
                            new Promise((_, reject) => 
                                setTimeout(() => reject(new Error('í¬íŠ¸ ì„ íƒ íƒ€ì„ì•„ì›ƒ')), 30000)
                            )
                        ]);

                        this.logToTerminal('ğŸ”— ì‹œë¦¬ì–¼ í¬íŠ¸ ì—´ê¸°...');
                        await this.serialPort.open({
                            baudRate: deviceConfig.baudRate,
                            dataBits: 8,
                            stopBits: 1,
                            parity: 'none'
                        });

                        this.logToTerminal('âœ… ì‹œë¦¬ì–¼ í¬íŠ¸ ì—°ê²° ì„±ê³µ!');
                        
                        // ì—°ê²° í™•ì¸ì„ ìœ„í•œ ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸
                        try {
                            await this.verifyDeviceType();
                        } catch (verifyError) {
                            this.logToTerminal(`âš ï¸  ì¥ë¹„ í™•ì¸ ì‹¤íŒ¨ (ê³„ì† ì§„í–‰): ${verifyError.message}`);
                        }
                        
                        this.isConnected = true;
                        this.logToTerminal('ğŸ‰ ì¥ë¹„ ì—°ê²° ë° ì´ˆê¸°í™” ì™„ë£Œ!');
                        this.startRealCapture();
                        
                    } catch (error) {
                        this.logToTerminal(`âŒ ì—°ê²° ì‹¤íŒ¨: ${error.message}`);
                        
                        // íŠ¹ì • ì˜¤ë¥˜ì— ëŒ€í•œ í•´ê²°ì±… ì œì‹œ
                        if (error.message.includes('message port closed')) {
                            this.logToTerminal('ğŸ’¡ Chrome í™•ì¥ í”„ë¡œê·¸ë¨ê³¼ì˜ ì¶©ëŒì…ë‹ˆë‹¤.');
                            this.logToTerminal('ğŸ’¡ í•´ê²°ë°©ë²•: ì‹œí¬ë¦¿ ëª¨ë“œì—ì„œ ì‹œë„í•˜ê±°ë‚˜ í™•ì¥ í”„ë¡œê·¸ë¨ì„ ë¹„í™œì„±í™”í•˜ì„¸ìš”.');
                        } else if (error.name === 'NotFoundError') {
                            this.logToTerminal('ğŸ’¡ í•´ê²°ë°©ë²•: ì¥ë¹„ê°€ USBì— ì—°ê²°ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”');
                        } else if (error.name === 'SecurityError') {
                            this.logToTerminal('ğŸ’¡ í•´ê²°ë°©ë²•: HTTPS í™˜ê²½ì—ì„œ ì ‘ì†í•˜ì„¸ìš”');
                        } else if (error.name === 'NotSupportedError') {
                            this.logToTerminal('ğŸ’¡ í•´ê²°ë°©ë²•: Chrome ë˜ëŠ” Edge ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”');
                        }
                        
                        this.elements.connectionStatus.textContent = `ì—°ê²° ì‹¤íŒ¨: ${error.message}`;
                        this.elements.connectBtn.disabled = false;
                        return;
                    }
                } else {
                    setTimeout(() => {
                        this.isConnected = true;
                        this.serialPort = null;
                        this.logToTerminal('âœ… ì‹œë®¬ë ˆì´ì…˜ ì¥ë¹„ ì—°ê²° ì™„ë£Œ!');
                        this.updateConnectionStatus();
                        this.startSimulation();
                    }, 1000);
                    return;
                }

                this.updateConnectionStatus();
            }

            async verifyDeviceType() {
                try {
                    await this.sendDeviceCommand('info');
                    this.logToTerminal('âœ… ì¥ë¹„ íƒ€ì… í™•ì¸ ì™„ë£Œ');
                } catch (error) {
                    this.logToTerminal(`âš ï¸  ì¥ë¹„ íƒ€ì… í™•ì¸ ì‹¤íŒ¨ (ê³„ì† ì§„í–‰): ${error.message}`);
                }
            }

            async disconnect() {
                this.logToTerminal('ğŸ”Œ ì¥ë¹„ ì—°ê²° í•´ì œ ì¤‘...');
                this.isCapturing = false;
                
                if (this.serialPort && !this.simulationMode) {
                    try {
                        await this.serialPort.close();
                        this.logToTerminal('âœ… ì‹œë¦¬ì–¼ í¬íŠ¸ ë‹«ê¸° ì™„ë£Œ');
                    } catch (error) {
                        this.logToTerminal(`âš ï¸  í¬íŠ¸ ë‹«ê¸° ì‹¤íŒ¨: ${error.message}`);
                    }
                }

                this.isConnected = false;
                this.serialPort = null;
                this.updateConnectionStatus();
                this.logToTerminal('ğŸ”Œ ì¥ë¹„ ì—°ê²° í•´ì œ ì™„ë£Œ');
                
                // í™”ë©´ ì´ˆê¸°í™”
                this.ctx.fillStyle = '#000';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
            }

            updateConnectionStatus() {
                const safeUpdate = (elementId, callback) => {
                    const element = this.elements && this.elements[elementId];
                    if (element && callback) {
                        try {
                            callback(element);
                        } catch (error) {
                            console.warn(`ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${elementId}`, error);
                        }
                    }
                };

                if (this.isConnected) {
                    safeUpdate('statusDot', (el) => el.classList.add('connected'));
                    safeUpdate('connectionStatus', (el) => el.textContent = this.simulationMode ? 'ì‹œë®¬ë ˆì´ì…˜ ì—°ê²°' : 'ì‹¤ì œ ì¥ë¹„ ì—°ê²°');
                    safeUpdate('screenOverlay', (el) => el.style.display = 'none');
                    safeUpdate('connectBtn', (el) => el.disabled = true);
                    safeUpdate('disconnectBtn', (el) => el.disabled = false);
                    safeUpdate('pauseBtn', (el) => el.disabled = false);
                    safeUpdate('resumeBtn', (el) => el.disabled = false);
                } else {
                    safeUpdate('statusDot', (el) => el.classList.remove('connected'));
                    safeUpdate('connectionStatus', (el) => el.textContent = 'ì—°ê²° ì•ˆë¨');
                    safeUpdate('screenOverlay', (el) => el.style.display = 'flex');
                    safeUpdate('connectBtn', (el) => el.disabled = false);
                    safeUpdate('disconnectBtn', (el) => el.disabled = true);
                    safeUpdate('pauseBtn', (el) => el.disabled = true);
                    safeUpdate('resumeBtn', (el) => el.disabled = true);
                }
            }

            async sendDeviceCommand(command) {
                if (!this.simulationMode && this.serialPort) {
                    try {
                        // Chrome í™•ì¥ í”„ë¡œê·¸ë¨ ì¶©ëŒ ë°©ì§€
                        if (!this.serialPort.writable || !this.serialPort.readable) {
                            throw new Error('ì‹œë¦¬ì–¼ í¬íŠ¸ê°€ ì‚¬ìš© ë¶ˆê°€ëŠ¥í•œ ìƒíƒœì…ë‹ˆë‹¤');
                        }
                        
                        const encoder = new TextEncoder();
                        const writer = this.serialPort.writable.getWriter();
                        
                        // ì“°ê¸° ì‘ì—…ì„ íƒ€ì„ì•„ì›ƒê³¼ í•¨ê»˜ ì‹¤í–‰
                        await Promise.race([
                            writer.write(encoder.encode(command + '\r\n')),
                            new Promise((_, reject) => 
                                setTimeout(() => reject(new Error('ëª…ë ¹ ì „ì†¡ íƒ€ì„ì•„ì›ƒ')), 5000)
                            )
                        ]);
                        
                        writer.releaseLock();
                        
                        this.logToTerminal(`ğŸ“¤ ëª…ë ¹: ${command}`);
                        this.addToCommandHistory(command);
                        
                        // ì‘ë‹µ ì½ê¸°
                        const reader = this.serialPort.readable.getReader();
                        
                        try {
                            const response = await Promise.race([
                                reader.read(),
                                new Promise((_, reject) => 
                                    setTimeout(() => reject(new Error('ì‘ë‹µ ì½ê¸° íƒ€ì„ì•„ì›ƒ')), 3000)
                                )
                            ]);
                            
                            if (response.value) {
                                const decoder = new TextDecoder();
                                const responseText = decoder.decode(response.value);
                                this.logToTerminal(`ğŸ“¥ ì‘ë‹µ: ${responseText.trim()}`);
                                return responseText;
                            }
                        } catch (readError) {
                            if (readError.message.includes('message port closed')) {
                                this.logToTerminal('âš ï¸  Chrome í™•ì¥ í”„ë¡œê·¸ë¨ ì¶©ëŒ ê°ì§€');
                                throw new Error('í™•ì¥ í”„ë¡œê·¸ë¨ ì¶©ëŒë¡œ ì¸í•œ ì—°ê²° ì‹¤íŒ¨');
                            }
                            this.logToTerminal(`ğŸ“¥ ì½ê¸° ì‹¤íŒ¨: ${readError.message}`);
                        } finally {
                            try {
                                reader.releaseLock();
                            } catch (e) {
                                // readerê°€ ì´ë¯¸ í•´ì œëœ ê²½ìš° ë¬´ì‹œ
                            }
                        }
                        
                    } catch (error) {
                        if (error.message.includes('message port closed')) {
                            this.logToTerminal('ğŸ”„ Chrome í™•ì¥ í”„ë¡œê·¸ë¨ ì¶©ëŒ - ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œë¡œ ì „í™˜');
                            showExtensionWarning(); // ì•Œë¦¼ í‘œì‹œ
                            this.simulationMode = true;
                            this.disconnect();
                            this.simulateDeviceResponse(command);
                            return;
                        }
                        
                        this.logToTerminal(`âŒ ëª…ë ¹ ì‹¤íŒ¨: ${error.message}`);
                        throw error;
                    }
                } else {
                    // ì‹œë®¬ë ˆì´ì…˜ ì‘ë‹µ
                    this.logToTerminal(`ğŸ® ì‹œë®¬ë ˆì´ì…˜ ëª…ë ¹: ${command}`);
                    this.addToCommandHistory(command);
                    this.simulateDeviceResponse(command);
                    return `Simulated response for: ${command}`;
                }
            }

            simulateDeviceResponse(command) {
                setTimeout(() => {
                    const responses = {
                        'vbat': 'ì‘ë‹µ: Battery: 3.7V',
                        'info': 'ì‘ë‹µ: tinySA Ultra v1.4.5',
                        'version': 'ì‘ë‹µ: Firmware v1.4.5-20241201',
                        'help': 'ì‘ë‹µ: scan, sweep, cal, save, recall, marker, capture...',
                        'scan': 'ì‘ë‹µ: Scan complete',
                        'sweep': 'ì‘ë‹µ: Sweep complete'
                    };
                    
                    const response = responses[command.split(' ')[0]] || 'ì‘ë‹µ: OK';
                    this.logToTerminal(response);
                }, 300);
            }

            addToCommandHistory(command) {
                if (this.elements.commandHistory) {
                    const timestamp = new Date().toLocaleTimeString();
                    const line = document.createElement('div');
                    line.textContent = `[${timestamp}] ${command}`;
                    this.elements.commandHistory.appendChild(line);
                    this.elements.commandHistory.scrollTop = this.elements.commandHistory.scrollHeight;
                }
            }

            // ===== ìŠ¤í™íŠ¸ëŸ¼ ìŠ¤ìº” ê¸°ëŠ¥ =====
            async startSpectrumScan() {
                this.logToTerminal('ğŸ“Š ìŠ¤í™íŠ¸ëŸ¼ ìŠ¤ìº” ì‹œì‘...');
                this.updateScanStatus('ìŠ¤ìº” ì¤‘...', 0);
                
                const startFreq = parseFloat(this.elements.startFreq.value) * 1e6;
                const stopFreq = parseFloat(this.elements.stopFreq.value) * 1e6;
                const points = parseInt(this.elements.points.value);
                
                if (this.simulationMode) {
                    this.generateSimulatedSpectrum(startFreq, stopFreq, points);
                } else {
                    await this.realSpectrumScan(startFreq, stopFreq, points);
                }
                
                this.updateScanStatus('ìŠ¤ìº” ì™„ë£Œ', 100);
                this.drawSpectrumChart();
                this.updateMeasurements();
            }

            generateSimulatedSpectrum(startFreq, stopFreq, points) {
                this.spectrumData.frequencies = [];
                this.spectrumData.powers = [];
                
                for (let i = 0; i < points; i++) {
                    const freq = startFreq + (stopFreq - startFreq) * i / (points - 1);
                    const power = -60 + 30 * Math.sin(freq / 100e6) + Math.random() * 10;
                    
                    this.spectrumData.frequencies.push(freq);
                    this.spectrumData.powers.push(power);
                    
                    // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
                    const progress = (i / points) * 100;
                    this.updateScanStatus(`ìŠ¤ìº” ì¤‘... ${Math.round(progress)}%`, progress);
                }
                
                this.logToTerminal(`âœ… ì‹œë®¬ë ˆì´ì…˜ ìŠ¤í™íŠ¸ëŸ¼ ìƒì„±: ${points} í¬ì¸íŠ¸`);
            }

            async realSpectrumScan(startFreq, stopFreq, points) {
                try {
                    await this.sendDeviceCommand(`scanraw ${startFreq} ${stopFreq} ${points}`);
                    // ì‹¤ì œ ìŠ¤ìº” ë°ì´í„° ì²˜ë¦¬ ë¡œì§
                    this.logToTerminal('âœ… ì‹¤ì œ ìŠ¤í™íŠ¸ëŸ¼ ìŠ¤ìº” ì™„ë£Œ');
                } catch (error) {
                    this.logToTerminal(`âŒ ìŠ¤í™íŠ¸ëŸ¼ ìŠ¤ìº” ì‹¤íŒ¨: ${error.message}`);
                    this.generateSimulatedSpectrum(startFreq, stopFreq, points);
                }
            }

            updateScanStatus(status, progress) {
                if (this.elements.scanStatus) {
                    this.elements.scanStatus.textContent = status;
                }
                if (this.elements.progressFill) {
                    this.elements.progressFill.style.width = `${progress}%`;
                }
            }

            // ===== S-parameter ì¸¡ì • =====
            async startSweep() {
                this.logToTerminal('ğŸ“ˆ S-parameter ìŠ¤ìœ„í”„ ì‹œì‘...');
                const measurementType = this.elements.measurementType.value;
                
                if (this.simulationMode) {
                    this.generateSimulatedSParameters();
                } else {
                    await this.realSParameterSweep(measurementType);
                }
                
                this.drawSmithChart();
                this.updateDataTable();
            }

            generateSimulatedSParameters() {
                const points = parseInt(this.elements.points.value);
                const startFreq = parseFloat(this.elements.startFreq.value) * 1e6;
                const stopFreq = parseFloat(this.elements.stopFreq.value) * 1e6;
                
                this.spectrumData.frequencies = [];
                this.spectrumData.s11 = [];
                this.spectrumData.s21 = [];
                this.spectrumData.phases = [];
                
                for (let i = 0; i < points; i++) {
                    const freq = startFreq + (stopFreq - startFreq) * i / (points - 1);
                    const s11 = -15 + 10 * Math.sin(freq / 100e6) + Math.random() * 2;
                    const s21 = -1 - freq / 1e9 + Math.random() * 0.5;
                    const phase = (freq / 1e6) % 360 - 180;
                    
                    this.spectrumData.frequencies.push(freq);
                    this.spectrumData.s11.push(s11);
                    this.spectrumData.s21.push(s21);
                    this.spectrumData.phases.push(phase);
                }
                
                this.logToTerminal(`âœ… ì‹œë®¬ë ˆì´ì…˜ S-parameter ìƒì„±: ${points} í¬ì¸íŠ¸`);
            }

            async realSParameterSweep(measurementType) {
                try {
                    switch (measurementType) {
                        case 's11':
                            await this.sendDeviceCommand('data 0');
                            break;
                        case 's21':
                            await this.sendDeviceCommand('data 1');
                            break;
                        case 's11s21':
                            await this.sendDeviceCommand('data 0 1');
                            break;
                    }
                    this.logToTerminal('âœ… ì‹¤ì œ S-parameter ì¸¡ì • ì™„ë£Œ');
                } catch (error) {
                    this.logToTerminal(`âŒ S-parameter ì¸¡ì • ì‹¤íŒ¨: ${error.message}`);
                    this.generateSimulatedSParameters();
                }
            }

            // ===== ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ê¸°ëŠ¥ =====
            async calibrateOpen() {
                this.logToTerminal('ğŸ”“ OPEN ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì‹œì‘...');
                await this.sendDeviceCommand('cal open');
            }

            async calibrateShort() {
                this.logToTerminal('âš¡ SHORT ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì‹œì‘...');
                await this.sendDeviceCommand('cal short');
            }

            async calibrateLoad() {
                this.logToTerminal('ğŸ”© LOAD ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì‹œì‘...');
                await this.sendDeviceCommand('cal load');
            }

            async calibrateThrough() {
                this.logToTerminal('ğŸ”— THROUGH ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì‹œì‘...');
                await this.sendDeviceCommand('cal thru');
            }

            async saveCalibration() {
                this.logToTerminal('ğŸ’¾ ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì €ì¥ ì¤‘...');
                await this.sendDeviceCommand('save');
            }

            async recallCalibration() {
                this.logToTerminal('ğŸ“‚ ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ë¡œë“œ ì¤‘...');
                await this.sendDeviceCommand('recall');
            }

            async clearCalibration() {
                this.logToTerminal('ğŸ—‘ï¸  ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì´ˆê¸°í™”...');
                await this.sendDeviceCommand('cal reset');
            }

            // ===== ë§ˆì»¤ ê¸°ëŠ¥ =====
            setMarker() {
                const freq = parseFloat(this.elements.markerFreq.value) * 1e6;
                this.markers.push({ frequency: freq, type: 'manual' });
                this.logToTerminal(`ğŸ“ ë§ˆì»¤ ì„¤ì •: ${freq / 1e6} MHz`);
                this.updateMarkerInfo();
                this.drawSpectrumChart();
            }

            setPeakMarker() {
                if (this.spectrumData.powers.length > 0) {
                    const maxIndex = this.spectrumData.powers.indexOf(Math.max(...this.spectrumData.powers));
                    const peakFreq = this.spectrumData.frequencies[maxIndex];
                    this.markers.push({ frequency: peakFreq, type: 'peak' });
                    this.logToTerminal(`ğŸ”ï¸  Peak ë§ˆì»¤ ì„¤ì •: ${(peakFreq / 1e6).toFixed(3)} MHz`);
                    this.updateMarkerInfo();
                    this.drawSpectrumChart();
                }
            }

            clearMarkers() {
                this.markers = [];
                this.logToTerminal('ğŸ—‘ï¸  ëª¨ë“  ë§ˆì»¤ ì‚­ì œ');
                this.updateMarkerInfo();
                this.drawSpectrumChart();
            }

            updateMarkerInfo() {
                if (this.elements.markerInfo) {
                    if (this.markers.length === 0) {
                        this.elements.markerInfo.textContent = 'ë§ˆì»¤ ì—†ìŒ';
                    } else {
                        const info = this.markers.map((marker, index) => 
                            `M${index + 1}: ${(marker.frequency / 1e6).toFixed(3)} MHz (${marker.type})`
                        ).join('\n');
                        this.elements.markerInfo.textContent = info;
                    }
                }
            }

            // ===== ë°ì´í„° ê´€ë¦¬ =====
            saveData() {
                if (this.spectrumData.frequencies.length === 0) {
                    this.logToTerminal('âŒ ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
                    return;
                }
                
                const data = {
                    frequencies: this.spectrumData.frequencies,
                    powers: this.spectrumData.powers,
                    s11: this.spectrumData.s11,
                    s21: this.spectrumData.s21,
                    phases: this.spectrumData.phases,
                    markers: this.markers,
                    timestamp: new Date().toISOString()
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                this.downloadFile(blob, `spectrum_data_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`);
                this.logToTerminal('ğŸ’¾ ì¸¡ì • ë°ì´í„° ì €ì¥ ì™„ë£Œ');
            }

            saveTouchstone() {
                if (this.spectrumData.s11.length === 0) {
                    this.logToTerminal('âŒ S-parameter ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
                    return;
                }
                
                let touchstone = `! ${this.getDeviceConfig().name} Data\n`;
                touchstone += `! Date: ${new Date().toISOString()}\n`;
                touchstone += `# Hz S DB R 50\n`;
                
                for (let i = 0; i < this.spectrumData.frequencies.length; i++) {
                    const freq = this.spectrumData.frequencies[i];
                    const s11 = this.spectrumData.s11[i] || 0;
                    const s21 = this.spectrumData.s21[i] || 0;
                    const phase = this.spectrumData.phases[i] || 0;
                    
                    touchstone += `${freq.toFixed(0)} ${s11.toFixed(6)} ${phase.toFixed(3)} ${s21.toFixed(6)} 0.000\n`;
                }
                
                const blob = new Blob([touchstone], { type: 'text/plain' });
                this.downloadFile(blob, `measurement_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.s2p`);
                this.logToTerminal('ğŸ“„ Touchstone íŒŒì¼ ì €ì¥ ì™„ë£Œ');
            }

            exportCSV() {
                if (this.spectrumData.frequencies.length === 0) {
                    this.logToTerminal('âŒ ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
                    return;
                }
                
                let csv = 'Frequency(Hz),Power(dBm),S11(dB),S21(dB),Phase(deg)\n';
                
                for (let i = 0; i < this.spectrumData.frequencies.length; i++) {
                    const freq = this.spectrumData.frequencies[i];
                    const power = this.spectrumData.powers[i] || '';
                    const s11 = this.spectrumData.s11[i] || '';
                    const s21 = this.spectrumData.s21[i] || '';
                    const phase = this.spectrumData.phases[i] || '';
                    
                    csv += `${freq},${power},${s11},${s21},${phase}\n`;
                }
                
                const blob = new Blob([csv], { type: 'text/csv' });
                this.downloadFile(blob, `measurement_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.csv`);
                this.logToTerminal('ğŸ“Š CSV íŒŒì¼ ë‚´ë³´ë‚´ê¸° ì™„ë£Œ');
            }

            downloadFile(blob, filename) {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
            }

            // ===== ê³ ê¸‰ ì¸¡ì • ê¸°ëŠ¥ =====
            async timeDomainTransform() {
                this.logToTerminal('ğŸ•’ ì‹œê°„ ë„ë©”ì¸ ë³€í™˜ ì‹¤í–‰...');
                await this.sendDeviceCommand('transform time');
            }

            async noiseAnalysis() {
                this.logToTerminal('ğŸ”‡ ë…¸ì´ì¦ˆ ë¶„ì„ ì‹¤í–‰...');
                await this.sendDeviceCommand('noise');
            }

            async harmonicAnalysis() {
                this.logToTerminal('ğŸµ ê³ ì¡°íŒŒ ë¶„ì„ ì‹¤í–‰...');
                await this.sendDeviceCommand('harmonic');
            }

            async spuriousAnalysis() {
                this.logToTerminal('ğŸ“¡ ìŠ¤í“¨ë¦¬ì–´ìŠ¤ ë¶„ì„ ì‹¤í–‰...');
                await this.sendDeviceCommand('spurious');
            }

            async powerMeter() {
                this.logToTerminal('âš¡ íŒŒì›Œ ë¯¸í„° ëª¨ë“œ...');
                await this.sendDeviceCommand('power');
            }

            // ===== ì‹œìŠ¤í…œ ì œì–´ =====
            async systemReset() {
                this.logToTerminal('ğŸ”„ ì‹œìŠ¤í…œ ë¦¬ì…‹...');
                await this.sendDeviceCommand('reset');
            }

            async checkBattery() {
                this.logToTerminal('ğŸ”‹ ë°°í„°ë¦¬ ìƒíƒœ í™•ì¸...');
                const response = await this.sendDeviceCommand('vbat');
                if (this.elements.battery && response) {
                    const match = response.match(/(\d+\.\d+)V/);
                    if (match) {
                        this.elements.battery.textContent = match[1] + 'V';
                    }
                }
            }

            async syncTime() {
                this.logToTerminal('ğŸ• ì‹œê°„ ë™ê¸°í™”...');
                const now = new Date();
                const timeStr = now.toISOString();
                await this.sendDeviceCommand(`time ${timeStr}`);
            }

            async getDeviceInfo() {
                this.logToTerminal('â„¹ï¸  ì¥ë¹„ ì •ë³´ ì¡°íšŒ...');
                await this.sendDeviceCommand('info');
            }

            async getFirmwareVersion() {
                this.logToTerminal('ğŸ”§ íŒì›¨ì–´ ë²„ì „ í™•ì¸...');
                await this.sendDeviceCommand('version');
            }

            // ===== ëª…ë ¹ì–´ ì²˜ë¦¬ =====
            async sendCommand() {
                const command = this.elements.commandInput.value.trim();
                if (command) {
                    await this.sendDeviceCommand(command);
                    this.elements.commandInput.value = '';
                }
            }

            showHelp() {
                this.logToTerminal('ğŸ“š ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´:');
                this.logToTerminal('scan, sweep, data, frequencies, freq, power');
                this.logToTerminal('cal, save, recall, marker, capture, pause, resume');
                this.logToTerminal('vbat, info, version, help, reset, time');
                this.logToTerminal('transform, noise, harmonic, spurious');
            }

            // ===== ì°¨íŠ¸ ê·¸ë¦¬ê¸° =====
            drawSpectrumChart() {
                const ctx = this.spectrumCtx;
                const width = this.spectrumCanvas.width;
                const height = this.spectrumCanvas.height;
                
                // ë°°ê²½ ì§€ìš°ê¸°
                ctx.fillStyle = '#1a1a1a';
                ctx.fillRect(0, 0, width, height);
                
                // ê²©ì ê·¸ë¦¬ê¸°
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 1;
                
                for (let i = 0; i <= 10; i++) {
                    const x = (width * i) / 10;
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, height);
                    ctx.stroke();
                }
                
                for (let i = 0; i <= 8; i++) {
                    const y = (height * i) / 8;
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(width, y);
                    ctx.stroke();
                }
                
                // ìŠ¤í™íŠ¸ëŸ¼ ë°ì´í„° ê·¸ë¦¬ê¸°
                if (this.spectrumData.frequencies.length > 0) {
                    ctx.strokeStyle = '#00ff00';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    
                    const powers = this.spectrumData.powers.length > 0 ? this.spectrumData.powers : this.spectrumData.s11;
                    const minPower = Math.min(...powers);
                    const maxPower = Math.max(...powers);
                    const powerRange = maxPower - minPower || 1;
                    
                    for (let i = 0; i < powers.length; i++) {
                        const x = (width * i) / (powers.length - 1);
                        const y = height - ((powers[i] - minPower) / powerRange) * height;
                        
                        if (i === 0) {
                            ctx.moveTo(x, y);
                        } else {
                            ctx.lineTo(x, y);
                        }
                    }
                    ctx.stroke();
                    
                    // ë§ˆì»¤ ê·¸ë¦¬ê¸°
                    this.markers.forEach((marker, index) => {
                        const freqIndex = this.spectrumData.frequencies.findIndex(f => f >= marker.frequency);
                        if (freqIndex >= 0) {
                            const x = (width * freqIndex) / (powers.length - 1);
                            ctx.strokeStyle = marker.type === 'peak' ? '#ff0000' : '#ffff00';
                            ctx.lineWidth = 2;
                            ctx.beginPath();
                            ctx.moveTo(x, 0);
                            ctx.lineTo(x, height);
                            ctx.stroke();
                            
                            ctx.fillStyle = marker.type === 'peak' ? '#ff0000' : '#ffff00';
                            ctx.font = '12px Arial';
                            ctx.fillText(`M${index + 1}`, x + 5, 15);
                        }
                    });
                }
                
                // ì¶• ë ˆì´ë¸”
                ctx.fillStyle = '#fff';
                ctx.font = '12px Arial';
                ctx.fillText('ì£¼íŒŒìˆ˜', width - 50, height - 10);
                ctx.save();
                ctx.translate(15, height / 2);
                ctx.rotate(-Math.PI / 2);
                ctx.fillText('íŒŒì›Œ (dBm)', 0, 0);
                ctx.restore();
            }

            drawSmithChart() {
                const ctx = this.smithCtx;
                const width = this.smithCanvas.width;
                const height = this.smithCanvas.height;
                const centerX = width / 2;
                const centerY = height / 2;
                const radius = Math.min(width, height) / 2 - 20;
                
                // ë°°ê²½ ì§€ìš°ê¸°
                ctx.fillStyle = '#1a1a1a';
                ctx.fillRect(0, 0, width, height);
                
                // Smith ì°¨íŠ¸ ê²©ì ê·¸ë¦¬ê¸°
                ctx.strokeStyle = '#444';
                ctx.lineWidth = 1;
                
                // ì™¸ê³½ ì›
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
                ctx.stroke();
                
                // ì €í•­ ì›ë“¤
                for (let r = 0.2; r <= 5; r *= 2) {
                    const rRadius = radius / (1 + r);
                    const rCenterX = centerX + radius * r / (1 + r);
                    ctx.beginPath();
                    ctx.arc(rCenterX, centerY, rRadius, 0, 2 * Math.PI);
                    ctx.stroke();
                }
                
                // ë¦¬ì•¡í„´ìŠ¤ í˜¸ë“¤
                for (let x = 0.2; x <= 5; x *= 2) {
                    const xRadius = radius / x;
                    const xCenterY = centerY - radius / x;
                    ctx.beginPath();
                    ctx.arc(centerX + radius, xCenterY, xRadius, Math.PI / 2, 3 * Math.PI / 2);
                    ctx.stroke();
                    
                    const xCenterY2 = centerY + radius / x;
                    ctx.beginPath();
                    ctx.arc(centerX + radius, xCenterY2, xRadius, -Math.PI / 2, Math.PI / 2);
                    ctx.stroke();
                }
                
                // S11 ë°ì´í„° í”Œë¡¯
                if (this.spectrumData.s11.length > 0 && this.spectrumData.phases.length > 0) {
                    ctx.strokeStyle = '#00ff00';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    
                    for (let i = 0; i < this.spectrumData.s11.length; i++) {
                        const s11_linear = Math.pow(10, this.spectrumData.s11[i] / 20);
                        const phase_rad = this.spectrumData.phases[i] * Math.PI / 180;
                        
                        const real = s11_linear * Math.cos(phase_rad);
                        const imag = s11_linear * Math.sin(phase_rad);
                        
                        const x = centerX + real * radius;
                        const y = centerY - imag * radius;
                        
                        if (i === 0) {
                            ctx.moveTo(x, y);
                        } else {
                            ctx.lineTo(x, y);
                        }
                    }
                    ctx.stroke();
                }
                
                // ë ˆì´ë¸”
                ctx.fillStyle = '#fff';
                ctx.font = '12px Arial';
                ctx.fillText('Smith Chart', 5, 15);
                ctx.fillText('50Î©', centerX - 10, centerY - radius - 5);
            }

            updateDataTable() {
                if (!this.elements.dataTableBody) return;
                
                this.elements.dataTableBody.innerHTML = '';
                
                if (this.spectrumData.frequencies.length === 0) {
                    const row = this.elements.dataTableBody.insertRow();
                    const cell = row.insertCell();
                    cell.colSpan = 4;
                    cell.textContent = 'ë°ì´í„° ì—†ìŒ';
                    return;
                }
                
                for (let i = 0; i < Math.min(this.spectrumData.frequencies.length, 50); i++) {
                    const row = this.elements.dataTableBody.insertRow();
                    
                    const freqCell = row.insertCell();
                    freqCell.textContent = (this.spectrumData.frequencies[i] / 1e6).toFixed(3);
                    
                    const s11Cell = row.insertCell();
                    s11Cell.textContent = this.spectrumData.s11[i] ? this.spectrumData.s11[i].toFixed(2) : '-';
                    
                    const s21Cell = row.insertCell();
                    s21Cell.textContent = this.spectrumData.s21[i] ? this.spectrumData.s21[i].toFixed(2) : '-';
                    
                    const phaseCell = row.insertCell();
                    phaseCell.textContent = this.spectrumData.phases[i] ? this.spectrumData.phases[i].toFixed(1) : '-';
                }
            }

            updateMeasurements() {
                if (this.spectrumData.powers.length > 0) {
                    const powers = this.spectrumData.powers;
                    const frequencies = this.spectrumData.frequencies;
                    
                    const maxIndex = powers.indexOf(Math.max(...powers));
                    const peakFreq = frequencies[maxIndex];
                    const peakPower = powers[maxIndex];
                    const avgPower = powers.reduce((a, b) => a + b) / powers.length;
                    const noiseFloor = Math.min(...powers);
                    
                    if (this.elements.peakFreq) this.elements.peakFreq.textContent = `${(peakFreq / 1e6).toFixed(3)} MHz`;
                    if (this.elements.peakPower) this.elements.peakPower.textContent = `${peakPower.toFixed(1)} dBm`;
                    if (this.elements.avgPower) this.elements.avgPower.textContent = `${avgPower.toFixed(1)} dBm`;
                    if (this.elements.noiseFloor) this.elements.noiseFloor.textContent = `${noiseFloor.toFixed(1)} dBm`;
                }
                
                if (this.spectrumData.s11.length > 0) {
                    const s11 = this.spectrumData.s11[Math.floor(this.spectrumData.s11.length / 2)];
                    const phase = this.spectrumData.phases[Math.floor(this.spectrumData.phases.length / 2)];
                    
                    const reflection = Math.pow(10, s11 / 20);
                    const vswr = (1 + reflection) / (1 - reflection);
                    const returnLoss = -s11;
                    const impedance = 50 * (1 + reflection) / (1 - reflection);
                    
                    if (this.elements.vswr) this.elements.vswr.textContent = vswr.toFixed(2);
                    if (this.elements.returnLoss) this.elements.returnLoss.textContent = `${returnLoss.toFixed(1)} dB`;
                    if (this.elements.impedance) this.elements.impedance.textContent = `${impedance.toFixed(1)} Î©`;
                    if (this.elements.phase) this.elements.phase.textContent = `${phase.toFixed(1)}Â°`;
                }
            }

            // ===== íƒ­ ì „í™˜ =====
            switchTab(tabName) {
                // ëª¨ë“  íƒ­ ë²„íŠ¼ ë¹„í™œì„±í™”
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                // ì„ íƒëœ íƒ­ í™œì„±í™”
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
                document.getElementById(`${tabName}-tab`).classList.add('active');
                
                this.currentTab = tabName;
                this.logToTerminal(`ğŸ“„ íƒ­ ì „í™˜: ${tabName}`);
                
                // íƒ­ë³„ ì¶”ê°€ ë™ì‘
                switch (tabName) {
                    case 'spectrum':
                        this.drawSpectrumChart();
                        break;
                    case 'smith':
                        this.drawSmithChart();
                        break;
                    case 'data':
                        this.updateDataTable();
                        break;
                }
            }

            // ===== í™”ë©´ ë¯¸ëŸ¬ë§ (ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€) =====
            async startRealCapture() {
                if (!this.serialPort || this.simulationMode) {
                    this.startSimulation();
                    return;
                }
                
                this.isCapturing = true;
                this.logToTerminal('ğŸ¬ ì‹¤ì‹œê°„ í™”ë©´ ìº¡ì²˜ ì‹œì‘...');
                
                while (this.isCapturing && this.isConnected) {
                    try {
                        if (!this.isPaused) {
                            await this.sendDeviceCommand('capture');
                        }
                        this.updateFPS();
                        await this.delay(200);
                    } catch (error) {
                        this.logToTerminal(`âŒ ìº¡ì²˜ ì˜¤ë¥˜: ${error.message}`);
                        break;
                    }
                }
            }

            startSimulation() {
                if (!this.isConnected) return;
                
                this.isCapturing = true;
                this.logToTerminal('ğŸ® ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ ì‹œì‘');
                
                const simulate = () => {
                    if (!this.isCapturing || !this.isConnected) return;
                    
                    if (!this.isPaused) {
                        this.generateSimulatedScreen();
                        this.updateFPS();
                    }
                    
                    setTimeout(simulate, 200);
                };
                simulate();
            }

            generateSimulatedScreen() {
                const deviceConfig = this.getDeviceConfig();
                
                this.ctx.fillStyle = '#000';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                // ê²©ì
                this.ctx.strokeStyle = '#333';
                this.ctx.lineWidth = 1;
                
                for (let i = 0; i <= 10; i++) {
                    const x = (this.canvas.width * i) / 10;
                    this.ctx.beginPath();
                    this.ctx.moveTo(x, 0);
                    this.ctx.lineTo(x, this.canvas.height);
                    this.ctx.stroke();
                }
                
                for (let i = 0; i <= 8; i++) {
                    const y = (this.canvas.height * i) / 8;
                    this.ctx.beginPath();
                    this.ctx.moveTo(0, y);
                    this.ctx.lineTo(this.canvas.width, y);
                    this.ctx.stroke();
                }
                
                // ì‹œë®¬ë ˆì´ì…˜ ìŠ¤í™íŠ¸ëŸ¼
                this.ctx.strokeStyle = '#0f0';
                this.ctx.lineWidth = 2;
                this.ctx.beginPath();
                
                const time = Date.now() / 1000;
                for (let x = 0; x < this.canvas.width; x++) {
                    const freq = x / this.canvas.width;
                    const y = this.canvas.height * 0.8 - 
                        Math.sin(freq * Math.PI * 4 + time) * 30 -
                        Math.sin(freq * Math.PI * 8 + time * 2) * 15 -
                        Math.random() * 5;
                    
                    if (x === 0) {
                        this.ctx.moveTo(x, y);
                    } else {
                        this.ctx.lineTo(x, y);
                    }
                }
                this.ctx.stroke();
                
                // í…ìŠ¤íŠ¸ ì •ë³´
                this.ctx.fillStyle = '#fff';
                this.ctx.font = '12px Arial';
                this.ctx.fillText(`${deviceConfig.name} - ì‹œë®¬ë ˆì´ì…˜`, 10, 20);
                this.ctx.fillText('100kHz - 350MHz', 10, this.canvas.height - 30);
                this.ctx.fillText('Ref: -10dBm', 10, this.canvas.height - 15);
            }

            // ===== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ =====
            pauseCapture() {
                this.isPaused = true;
                this.logToTerminal('â¸ï¸  í™”ë©´ ìº¡ì²˜ ì¼ì‹œì •ì§€');
                if (this.elements.pauseBtn) this.elements.pauseBtn.disabled = true;
                if (this.elements.resumeBtn) this.elements.resumeBtn.disabled = false;
            }

            resumeCapture() {
                this.isPaused = false;
                this.logToTerminal('â–¶ï¸  í™”ë©´ ìº¡ì²˜ ì¬ê°œ');
                if (this.elements.pauseBtn) this.elements.pauseBtn.disabled = false;
                if (this.elements.resumeBtn) this.elements.resumeBtn.disabled = true;
            }

            zoomIn() {
                if (this.zoom < 4) {
                    this.zoom += 0.5;
                    this.updateScreenSize();
                }
            }

            zoomOut() {
                if (this.zoom > 1) {
                    this.zoom -= 0.5;
                    this.updateScreenSize();
                }
            }

            takeScreenshot() {
                const canvas = this.currentTab === 'screen' ? this.canvas : 
                              this.currentTab === 'spectrum' ? this.spectrumCanvas : this.smithCanvas;
                
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                const filename = `${this.deviceType}_${this.currentTab}_${timestamp}.png`;
                
                canvas.toBlob((blob) => {
                    this.downloadFile(blob, filename);
                    this.logToTerminal(`ğŸ“¸ ìŠ¤í¬ë¦°ìƒ· ì €ì¥: ${filename}`);
                });
            }

            handleScreenClick(event) {
                if (!this.isConnected) return;
                
                const rect = this.canvas.getBoundingClientRect();
                const scaleX = this.canvas.width / (rect.width / this.zoom);
                const scaleY = this.canvas.height / (rect.height / this.zoom);
                
                const x = Math.floor((event.clientX - rect.left) * scaleX);
                const y = Math.floor((event.clientY - rect.top) * scaleY);
                
                this.logToTerminal(`ğŸ‘† í„°ì¹˜: (${x}, ${y})`);
                
                if (!this.simulationMode && this.serialPort) {
                    this.sendDeviceCommand(`touch ${x} ${y}`);
                }
            }

            handleMouseMove(event) {
                // ë§ˆìš°ìŠ¤ ì»¤ì„œ ìœ„ì¹˜ í‘œì‹œ (ì˜µì…˜)
            }

            updateFPS() {
                this.frameCount++;
                const now = Date.now();
                
                if (now - this.lastFpsUpdate >= 1000) {
                    this.fps = this.frameCount;
                    this.frameCount = 0;
                    this.lastFpsUpdate = now;
                    
                    if (this.elements.fpsValue) {
                        this.elements.fpsValue.textContent = this.fps.toString();
                    }
                }
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            logToTerminal(message) {
                const timestamp = new Date().toLocaleTimeString();
                console.log(`[${timestamp}] ${message}`);
                
                if (!this.elements || !this.elements.terminal) {
                    const terminalElement = document.getElementById('terminal');
                    if (terminalElement) {
                        if (!this.elements) this.elements = {};
                        this.elements.terminal = terminalElement;
                    } else {
                        return;
                    }
                }
                
                try {
                    const line = document.createElement('div');
                    line.className = 'terminal-line';
                    line.textContent = `[${timestamp}] ${message}`;
                    this.elements.terminal.appendChild(line);
                    this.elements.terminal.scrollTop = this.elements.terminal.scrollHeight;
                    
                    const lines = this.elements.terminal.children;
                    if (lines.length > 100) {
                        lines[0].remove();
                    }
                } catch (error) {
                    console.error('í„°ë¯¸ë„ ë¡œê·¸ ì˜¤ë¥˜:', error);
                }
            }
        }

        // ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ì™„ì „í•œ tinySA Ultra ì›¹ ì»¨íŠ¸ë¡¤ëŸ¬ ì‹œì‘');
            window.controller = new CompleteTinySAController();
